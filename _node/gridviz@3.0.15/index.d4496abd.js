import{select as T}from"../d3-selection@3.0.0/index.13204b25.js";import{zoom as pt,zoomIdentity as yt}from"../d3-zoom@3.0.0/index.0e732a91.js";import{json as tt,csv as et,dsv as mt}from"../d3-fetch@3.0.1/index.e91238ad.js";import{randomNormal as wt}from"../d3-random@3.0.1/index.fd2cc361.js";import{color as G}from"../d3-color@3.1.0/index.e8c126ff.js";import{max as it,extent as bt}from"../d3-array@3.2.4/index.f89e3560.js";import{scaleQuantile as st}from"../d3-scale@4.0.2/index.61617510.js";import{interpolateLab as St}from"../d3-interpolate@3.0.1/index.7ed7c7fe.js";import{formatDefaultLocale as Ct}from"../d3-format@3.1.0/index.75f84505.js";let Z=class N{constructor(t,e=0,i=0,s=0,n=void 0){this.opts=n||{},this.canvas=t,this.w=this.canvas.offsetWidth,this.h=this.canvas.offsetHeight,this.canvas.width=this.w,this.canvas.height=this.h;const a=this.canvas.getContext("2d");if(!a)throw"Impossible to create canvas 2D context";if(this.ctx=a,this.view={x:e,y:i,z:s},this.backgroundColor=n.backgroundColor||"white",this.onZoomStartFun=n.onZoomStartFun,this.onZoomEndFun=n.onZoomEndFun,this.onZoomFun=n.onZoomFun,this.extGeo={xMin:NaN,xMax:NaN,yMin:NaN,yMax:NaN},this.updateExtentGeo(),!n.disableZoom){let o=yt;pt().wheelDelta(h=>-h.deltaY*(h.deltaMode===1?.07:h.deltaMode?1:.004)).on("zoom",h=>{const l=h.transform,r=o.k/l.k;if(r==1){const d=o.x-l.x,c=o.y-l.y;this.pan(d*this.view.z,-c*this.view.z)}else{const d=h.sourceEvent;if(d instanceof WheelEvent)this.zoom(r,this.pixToGeoX(h.sourceEvent.offsetX),this.pixToGeoY(h.sourceEvent.offsetY));else if(d instanceof TouchEvent){let c=0,f=0;for(let u of d.targetTouches)c+=u.clientX,f+=u.clientY;c/=d.targetTouches.length,f/=d.targetTouches.length,this.zoom(r,this.pixToGeoX(c),this.pixToGeoY(f))}}o=l,this.onZoomFun&&this.onZoomFun(h)}).on("start",h=>{this.canvasSave.c=document.createElement("canvas"),this.canvasSave.c.setAttribute("width",""+this.w),this.canvasSave.c.setAttribute("height",""+this.h),this.canvasSave.c.getContext("2d")?.drawImage(this.canvas,0,0),this.canvasSave.dx=0,this.canvasSave.dy=0,this.canvasSave.f=1,this.onZoomStartFun&&this.onZoomStartFun(h)}).on("end",h=>{this.redraw(),this.canvasSave={c:null,dx:0,dy:0,f:1},this.onZoomEndFun&&this.onZoomEndFun(h)})(T(this.canvas))}this.xMin=n.centerExtent?n.centerExtent[0]:void 0,this.yMin=n.centerExtent?n.centerExtent[1]:void 0,this.xMax=n.centerExtent?n.centerExtent[2]:void 0,this.yMax=n.centerExtent?n.centerExtent[3]:void 0,this.zoomExtent=n.zoomExtent||[0,1/0],this.canvasSave={c:null,dx:0,dy:0,f:1}}getView(){return this.view}setCenterExtent(t){this.xMin=t[0],this.yMin=t[1],this.xMax=t[2],this.yMax=t[3]}getCenterExtent(){return[this.xMin,this.yMin,this.xMax,this.yMax]}setZoomExtent(t){this.zoomExtent=t}getZoomExtent(){return this.zoomExtent}initCanvasTransform(){this.ctx.setTransform(1,0,0,1,0,0)}setCanvasTransform(){const t=1/this.view.z,e=-this.view.x/this.view.z+this.w*.5,i=this.view.y/this.view.z+this.h*.5;this.ctx.setTransform(t,0,0,-t,e,i)}getWebGLTransform(){const t=2/(this.w*this.view.z),e=2/(this.h*this.view.z);return[t,0,0,0,e,0,-t*this.view.x,-e*this.view.y,1]}redraw(){throw new Error("Method redraw not implemented.")}clear(t="white"){this.opts.transparentBackground?this.ctx.clearRect(0,0,this.w,this.h):(this.ctx&&(this.ctx.fillStyle=t),this.ctx.fillRect(0,0,this.w,this.h))}pan(t=0,e=0){this.xMin!=null&&this.view.x+t<this.xMin&&(t=this.xMin-this.view.x),this.yMin!=null&&this.view.y+e<this.yMin&&(e=this.yMin-this.view.y),this.xMax!=null&&this.view.x+t>this.xMax&&(t=this.xMax-this.view.x),this.yMax!=null&&this.view.y+e>this.yMax&&(e=this.yMax-this.view.y),this.view.x+=t,this.view.y+=e,this.updateExtentGeo(),this.canvasSave.c&&(this.canvasSave.dx-=t/this.view.z,this.canvasSave.dy+=e/this.view.z,this.clear(this.backgroundColor),this.ctx.drawImage(this.canvasSave.c,this.canvasSave.dx,this.canvasSave.dy))}zoom(t=1,e=this.view.x,i=this.view.y){if(this.zoomExtent[0]==this.view.z&&t<=1||this.zoomExtent[1]==this.view.z&&t>=1)return;const s=t*this.view.z;s<this.zoomExtent[0]&&(t=this.zoomExtent[0]/this.view.z),s>this.zoomExtent[1]&&(t=this.zoomExtent[1]/this.view.z),this.view.z*=t;let n=(e-this.view.x)*(1-t),a=(i-this.view.y)*(1-t);this.xMin!=null&&this.view.x+n<this.xMin&&(n=this.xMin-this.view.x),this.yMin!=null&&this.view.y+a<this.yMin&&(a=this.yMin-this.view.y),this.xMax!=null&&this.view.x+n>this.xMax&&(n=this.xMax-this.view.x),this.yMax!=null&&this.view.y+a>this.yMax&&(a=this.yMax-this.view.y),this.view.x+=n,this.view.y+=a,this.updateExtentGeo(),this.canvasSave.c&&(this.clear(this.backgroundColor),this.canvasSave.f/=t,this.canvasSave.dx=this.geoToPixX(e)*(1-this.canvasSave.f),this.canvasSave.dy=this.geoToPixY(i)*(1-this.canvasSave.f),this.clear(this.backgroundColor),this.ctx.drawImage(this.canvasSave.c,this.canvasSave.dx,this.canvasSave.dy,this.canvasSave.f*this.canvasSave.c.width,this.canvasSave.f*this.canvasSave.c.height))}updateExtentGeo(t=20){return this.extGeo={xMin:this.pixToGeoX(-t),xMax:this.pixToGeoX(this.w+t),yMin:this.pixToGeoY(this.h+t),yMax:this.pixToGeoY(-t)},this.extGeo}toDraw(t){return!(t.x<this.extGeo.xMin||t.x>this.extGeo.xMax||t.y<this.extGeo.yMin||t.y>this.extGeo.yMax)}geoToPixX(t){return(t-this.view.x)/this.view.z+this.w*.5}geoToPixY(t){return-(t-this.view.y)/this.view.z+this.h*.5}pixToGeoX(t){return(t-this.w*.5)*this.view.z+this.view.x}pixToGeoY(t){return-(t-this.h*.5)*this.view.z+this.view.y}setViewFromURL(){const t=N.getParameterByName("x"),e=N.getParameterByName("y"),i=N.getParameterByName("z");t!=null&&t!=null&&!isNaN(+t)&&(this.view.x=+t),e!=null&&e!=null&&!isNaN(+e)&&(this.view.y=+e),i!=null&&i!=null&&!isNaN(+i)&&(this.view.z=+i)}static getParameterByName(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),i=e.exec(location.search);return i?decodeURIComponent(i[1].replace(/\+/g," ")):null}},Mt=class{constructor(t){t=t||{},this.div=t.div||"tooltip_eurostat",this.maxWidth=t.maxWidth||"20em",this.fontSize=t.fontSize||"1.2em",this.background=t.background||"white",this.padding=t.padding||"5px",this.border=t.border||"0px",this["border-radius"]=t["border-radius"]||"0px",this["box-shadow"]=t["box-shadow"]||"5px 5px 5px grey",this["font-family"]=t["font-family"]||"Helvetica, Arial, sans-serif",this.transitionDuration=t.transitionDuration||100,this.xOffset=t.xOffset||30,this.yOffset=t.yOffset||20,this.yMouseOffset=t.yMouseOffset||0,this.xMouseOffset=t.xMouseOffset||0,this.parentElement=t.parentElement||document.body,this.tooltip=T("#"+this.div),this.tooltip.empty()&&(this.tooltip=T("body").append("div").attr("id",this.div)),this.tooltip.style("max-width",this.maxWidth),this.tooltip.style("overflow","hidden"),this.tooltip.style("font-size",this.fontSize),this.tooltip.style("background",this.background),this.tooltip.style("padding",this.padding),this.tooltip.style("border",this.border),this.tooltip.style("border-radius",this["border-radius"]),this.tooltip.style("box-shadow",this["box-shadow"]),this.tooltip.style("font-family",this["font-family"]),this.tooltip.style("position","absolute"),this.tooltip.style("pointer-events","none"),this.tooltip.style("opacity","0"),this.tooltip.style("text-wrap","nowrap"),this.tooltip.attr("role","tooltip").attr("aria-live","polite")}show(){this.tooltip.transition().duration(this.transitionDuration).style("opacity",1)}hide(){this.tooltip.transition().duration(this.transitionDuration).style("opacity",0)}html(t){this.tooltip.html(t)}setPosition(t){let e=this.parentElement.getBoundingClientRect(),i=t.pageX+this.xOffset,s=t.pageY-this.yOffset;this.tooltip.style("left",i+"px").style("top",s+"px"),this.ensureTooltipInsideContainer(t,e)}style(t,e){return arguments.length==1?this.tooltip.style(t):(this.tooltip.style(t,e),this)}attr(t,e){return arguments.length==1?this.tooltip.attr(t):(this.tooltip.attr(t,e),this)}ensureTooltipInsideContainer=function(t,e){let i=this.tooltip.node(),s=e.width,n=e.height;if(i.offsetLeft>e.left+s-i.clientWidth){let a=t.x-i.clientWidth-this.xOffset;if(i.style.left=a+"px",i.offsetLeft+i.clientWidth>t.x){let o=t.x-i.clientWidth-this.xOffset;i.style.left=o+"px"}}i.offsetTop+i.clientHeight>e.top+n&&(i.style.top=i.offsetTop-i.clientHeight+"px"),i.offsetTop<e.top&&(i.style.top=e.top+this.yOffset+"px")}},ot=class{constructor(t={}){this.map=t.map,this.parentNode=t.parentNode||t.map.container,t.id&&(this.div=T("#"+t.id)),(!this.div||this.div.empty())&&(this.div=T(document.createElement("div")),t.id&&this.div.attr("id",t.id)),t.title&&this.div.attr("title",t.title),t.class&&this.div.attr("class",t.class),t.onClickFunction&&this.div.on("click",t.onClickFunction),this.style("box-shadow","0 7px 8px rgba(0,47,103,.08), 0 0 22px rgba(0,47,103,.04), 0 12px 17px rgba(0,47,103,.04), 0 -4px 4px rgba(0,47,103,.04)"),this.style("background-color","#ffffff"),this.style("position","absolute"),this.style("cursor","pointer"),this.style("display","flex"),this.style("justify-content","center"),this.style("align-items","center"),this.style("width","30px"),this.style("height","30px"),this.parentNode.appendChild(this.div.node())}style(t,e){return this.div.style(t,e),this}},Tt=class extends ot{constructor(t){super(t),this.onZoom=t.onZoom,this.delta=t.delta||.2,this.zoomInBtn=document.createElement("a"),this.zoomInBtn.innerHTML='<a id="zoomin" class="gridviz-zoom-button" title="Zoom in">+</a>',this.zoomInBtn.title="Zoom in",this.zoomInBtn.addEventListener("click",e=>{this.zoomIn(e)}),this.zoomInBtn.addEventListener("mouseover",e=>{this.zoomInBtn.style.backgroundColor="lightgrey"}),this.zoomInBtn.addEventListener("mouseout",e=>{this.zoomInBtn.style.backgroundColor="#ffffff"}),this.zoomOutBtn=document.createElement("a"),this.zoomOutBtn.innerHTML='<a id="zoomin" class="gridviz-zoom-button" title="Zoom out">-</a>',this.zoomOutBtn.title="Zoom out",this.zoomOutBtn.addEventListener("click",e=>{this.zoomOut(e)}),this.zoomOutBtn.addEventListener("mouseover",e=>{this.zoomOutBtn.style.backgroundColor="lightgrey"}),this.zoomOutBtn.addEventListener("mouseout",e=>{this.zoomOutBtn.style.backgroundColor="#ffffff"}),[this.zoomInBtn,this.zoomOutBtn].forEach((e,i)=>{e.style.alignItems="center",e.style.justifyContent="center",e.style.display="flex",e.style.border="none",e.style.color="black",e.style.textAlign="center",e.style.textDecoration="none",e.style.padding="4px",e.style.fontSize="20px",e.style.fontWeight="bold",e.style.userSelect="none",i==0&&(e.style.borderBottom="1px solid grey")}),this.style("height","unset"),this.style("display","unset"),t.x?this.style("left",t.x+"px"):this.style("right","10px"),t.y?this.style("top",t.y+"px"):this.style("top","10px"),this.div.node().appendChild(this.zoomInBtn),this.div.node().appendChild(this.zoomOutBtn)}zoomIn(t){this.map.setZoom(this.map.getZoom()*(1-this.delta)).redraw(),this.onZoom&&this.onZoom(t)}zoomOut(t){this.map.setZoom(this.map.getZoom()*(1+this.delta)).redraw(),this.onZoom&&this.onZoom(t)}},zt=class extends ot{isFullscreen=!1;constructor(t){super(t),this.div.node().innerHTML=`
        <svg
            style="height: 1.2rem; width: 1.2rem; fill:black; margin:0;"
            focusable="false"
            aria-hidden="true"
        >
            <svg fill="#000000" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg">
            <title/>
            <g>
            <path d="M30,0H6A5.9966,5.9966,0,0,0,0,6V30a6,6,0,0,0,12,0V12H30A6,6,0,0,0,30,0Z"/>
            <path d="M90,0H66a6,6,0,0,0,0,12H84V30a6,6,0,0,0,12,0V6A5.9966,5.9966,0,0,0,90,0Z"/>
            <path d="M30,84H12V66A6,6,0,0,0,0,66V90a5.9966,5.9966,0,0,0,6,6H30a6,6,0,0,0,0-12Z"/>
            <path d="M90,60a5.9966,5.9966,0,0,0-6,6V84H66a6,6,0,0,0,0,12H90a5.9966,5.9966,0,0,0,6-6V66A5.9966,5.9966,0,0,0,90,60Z"/>
            </g>
            </svg>
        </svg>
        `,this.defaultHeight=this.map.h,this.defaultWidth=this.map.w,this.div.on("click",e=>{this.onClickFunction(e)}),this.div.on("mouseover",e=>{this.style("background-color","lightgrey")}),this.div.on("mouseout",e=>{this.style("background-color","#ffffff")}),t.x?this.style("left",t.x+"px"):this.style("right","10px"),t.y?this.style("top",t.y+"px"):this.style("top","90px")}onClickFunction(t){this.isFullscreen?(this.closeFullscreen(this.map.container),this.map.h=this.defaultHeight,this.map.w=this.defaultWidth,this.map.geoCanvas.h=this.defaultHeight,this.map.geoCanvas.w=this.defaultWidth,this.map.geoCanvas.canvas.setAttribute("width",""+this.defaultWidth),this.map.geoCanvas.canvas.setAttribute("height",""+this.defaultHeight),this.map.redraw(),this.isFullscreen=!1):(this.openFullscreen(this.map.container),this.map.h=window.screen.height,this.map.w=window.screen.width,this.isFullscreen=!0)}openFullscreen(t){t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen()}closeFullscreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}},kt=class{constructor(t,e){if(e=e||{},this.layers=e.layers||[],this.container=t||document.getElementById("gridviz"),!this.container){console.error("Cannot find gridviz container element.");return}this.container.style.position="relative",this.w=e.w||this.container.offsetWidth,this.h=e.h||this.container.offsetHeight,this._canvas=e.canvas||this.initialiseCanvas(),this.geoCanvas=new Z(this._canvas,e.x,e.y,e.z,e),this.geoCanvas.redraw=()=>{this.redraw()},this.legendDivId=e.legendDivId||"gvizLegend",this.legend=T("#"+this.legendDivId),this.legend.empty()&&this.initialiseLegend(),e.tooltip||(e.tooltip={}),e.tooltip.parentElement||(e.tooltip.parentElement=this.container),this.tooltip=new Mt(e.tooltip),this.mouseOverHandler=i=>this.focusCell(i),this.mouseMoveHandler=i=>this.focusCell(i),this.mouseOutHandler=i=>this.tooltip.hide(),this.geoCanvas.canvas.addEventListener("mouseover",this.mouseOverHandler),this.geoCanvas.canvas.addEventListener("mousemove",this.mouseMoveHandler),this.geoCanvas.canvas.addEventListener("mouseout",this.mouseOutHandler),this.geoCanvas.onZoomStartFun=i=>{e.onZoomStartFun&&e.onZoomStartFun(i),this.tooltip.hide()},this.canvasSave=null,this.selectionRectangleColor=e.selectionRectangleColor||"red",this.selectionRectangleWidthPix=e.selectionRectangleWidthPix||(()=>4),this.transparentBackground=e.transparentBackground,this.defaultGlobalCompositeOperation=e.defaultGlobalCompositeOperation||this.geoCanvas.ctx.globalCompositeOperation}initialiseCanvas(){const t=document.createElement("canvas");return t.setAttribute("width",""+this.w),t.setAttribute("height",""+this.h),this.container.appendChild(t),t}initialiseLegend(){this.legend=T(this.container.id&&this.container.id!=""?"#"+this.container.id:"body").append("div").attr("id",this.legendDivId).style("position","absolute").style("width","auto").style("height","auto").style("background","#FFFFFF").style("border","0px").style("box-shadow","3px 3px 3px grey, -3px -3px 3px #ddd").style("font-family","Helvetica, Arial, sans-serif").style("bottom","15px").style("right","15px")}layers_(t){return arguments.length===0?this.layers:(arguments.length===1?Array.isArray(t)?this.layers=t:this.layers=[t]:this.layers=arguments,this)}redraw(){this.legend&&this.legend.selectAll("*").remove(),this.geoCanvas.initCanvasTransform(),this.geoCanvas.clear(this.geoCanvas.backgroundColor);const t=this.geoCanvas.view.z;this.updateExtentGeo();for(const e of this.layers)e.visible&&!e.visible(t)||(this.geoCanvas.ctx.globalAlpha=e.alpha?e.alpha(t):1,e.blendOperation&&(this.geoCanvas.ctx.globalCompositeOperation=e.blendOperation(t)),this.geoCanvas.setCanvasTransform(),e.draw(this.geoCanvas,this.legend),e.filterColor&&e.drawFilter(this.geoCanvas),this.geoCanvas.ctx.globalAlpha=1,this.geoCanvas.ctx.globalCompositeOperation=this.defaultGlobalCompositeOperation);return this.canvasSave=null,this.defineResizeObserver(this.container,this._canvas),this}updateExtentGeo(t=20){return this.geoCanvas.updateExtentGeo(t)}focusCell(t){const e={x:this.geoCanvas.pixToGeoX(t.offsetX+this.tooltip.xMouseOffset),y:this.geoCanvas.pixToGeoY(t.offsetY+this.tooltip.yMouseOffset)},i=this.getCellFocusInfo(e);if(this.transparentBackground){i?(this.tooltip.html(i.html),this.tooltip.setPosition(t),this.tooltip.show()):this.tooltip.hide(),this.canvasSave=document.createElement("canvas"),this.canvasSave.setAttribute("width",""+this.w),this.canvasSave.setAttribute("height",""+this.h),this.canvasSave.getContext("2d")?.drawImage(this.geoCanvas.canvas,0,0),this.geoCanvas.initCanvasTransform();return}if(i){this.tooltip.html(i.html),this.tooltip.setPosition(t),this.tooltip.show(),this.canvasSave?this.geoCanvas.ctx.drawImage(this.canvasSave,0,0):(this.canvasSave=document.createElement("canvas"),this.canvasSave.setAttribute("width",""+this.w),this.canvasSave.setAttribute("height",""+this.h),this.canvasSave.getContext("2d")?.drawImage(this.geoCanvas.canvas,0,0));const s=this.selectionRectangleWidthPix?this.selectionRectangleWidthPix(i.resolution,this.geoCanvas.view.z):4;this.geoCanvas.initCanvasTransform(),this.geoCanvas.ctx.strokeStyle=this.selectionRectangleColor,this.geoCanvas.ctx.lineWidth=s,this.geoCanvas.ctx.beginPath(),this.geoCanvas.ctx.rect(this.geoCanvas.geoToPixX(i.cell.x)-s/2,this.geoCanvas.geoToPixY(i.cell.y)+s/2,i.resolution/this.geoCanvas.view.z+s,-i.resolution/this.geoCanvas.view.z-s),this.geoCanvas.ctx.stroke()}else this.tooltip.hide(),this.canvasSave&&this.geoCanvas.ctx.drawImage(this.canvasSave,0,0)}getCellFocusInfo(t){const e=this.geoCanvas.view.z;for(let i=this.layers.length-1;i>=0;i--){const s=this.layers[i];if(s.visible&&!s.visible(e)||!s.cellInfoHTML||!s.getDataset)continue;const n=s.getDataset(e);if(!n)continue;const a=n.getCellFromPosition(t,n.getViewCache());if(!a)return;if(n.mixedResolution){const h=+n.mixedResolution(a),l=s.cellInfoHTML(a,h);return l?{cell:a,html:l,resolution:h}:void 0}const o=s.cellInfoHTML(a,n.getResolution());return o?{cell:a,html:o,resolution:n.getResolution()}:void 0}}setView(t,e,i=void 0){return this.geoCanvas.view.x=t,this.geoCanvas.view.y=e,i!=null&&(this.geoCanvas.view.z=i),this}getView(){return this.geoCanvas.view}getZoom(){return this.geoCanvas.view.z}setZoom(t){return this.geoCanvas.view.z=t,this}getCenterExtent(){return this.geoCanvas.getCenterExtent()}setCenterExtent(t){return this.geoCanvas.setCenterExtent(t),this}getZoomExtent(){return this.geoCanvas.getZoomExtent()}setZoomExtent(t){return this.geoCanvas.setZoomExtent(t),this}getBackgroundColor(){return this.geoCanvas.backgroundColor}setBackgroundColor(t){return this.geoCanvas.backgroundColor=t,this}addZoomButtons(t){return this.zoomButtons=new Tt({map:this,id:t?.id||"gridviz-zoom-buttons",class:t?.class,x:t?.x,y:t?.y,onZoom:t?.onZoom,delta:t?.delta||.2}),this}addFullscreenButton(t){return this.fullscreenButton=new zt({map:this,id:t?.id||"gridviz-fullscreen-button",class:t?.class,x:t?.x,y:t?.y}),this}setViewFromURL(){return this.geoCanvas.setViewFromURL(),this}defineResizeObserver(t,e){new ResizeObserver(i=>{t.clientWidth>0&&t.clientHeight>0&&window.requestAnimationFrame(()=>{!Array.isArray(i)||!i.length||(this.h!==t.clientHeight||this.w!==t.clientWidth)&&(this.h=t.clientHeight,this.w=t.clientWidth,this.geoCanvas.h=t.clientHeight,this.geoCanvas.w=t.clientWidth,e.setAttribute("width",""+this.w),e.setAttribute("height",""+this.h),this.redraw())})}).observe(t)}destroy(){this.layers=[],this.bgLayers=[],this.container.removeEventListener("mouseover",this.mouseOverHandler),this.container.removeEventListener("mousemove",this.mouseMoveHandler),this.container.removeEventListener("mouseout",this.mouseOutHandler),this.geoCanvas.canvas.remove(),this.legend?.remove(),this.tooltip.tooltip?.remove()}},nt=class{constructor(t){t=t||{},this.visible=t.visible,this.alpha=t.alpha,this.blendOperation=t.blendOperation||(e=>"source-over"),this.filterColor=t.filterColor}drawFilter(t){if(!this.filterColor)return;const e=this.filterColor(t.view.z);!e||e=="none"||(t.ctx.fillStyle=e,t.ctx.fillRect(0,0,t.w,t.h))}},M=class gt extends nt{constructor(t){super(t),t=t||{},this.viewScale=t.viewScale,this.filter=t.filter||(()=>!0),this.offset=t.offset||((e,i,s)=>({dx:0,dy:0})),this.drawFun=t.drawFun,this.legends=[]}draw(t,e,i){if(this.drawFun)this.drawFun(t,e,i);else throw new Error("Method draw not implemented.")}getOffset(){return this.offset}setOffset(t){return this.offset=t,this}updateLegends(t){return gt.updateLegendsRecursive(this.legends,t),this}static updateLegendsRecursive(t,e){if(Array.isArray(t))for(const i of t)this.updateLegendsRecursive(i,e);else t.update(e)}addLegends(t){for(let e of t)this.legends.push(e);return this}},P=class extends nt{draw(t,e=void 0){throw new Error("Method draw not implemented.")}},O=class{constructor(t,e,i,s={}){this.map=t,this.url=e,this.resolution=i,this.mixedResolution=s.mixedResolution,this.preprocess=s.preprocess||void 0,this.cellsViewCache=[]}getData(t=void 0){throw new Error("Method getData not implemented.")}updateViewCache(t){throw new Error("Method updateViewCache not implemented.")}getCellFromPosition(t,e){if(this.mixedResolution){for(const s of e){const n=+this.mixedResolution(s);if(!(t.x<s.x)){if(s.x+n<t.x||t.y<s.y||s.y+n<t.y)continue;return s}}return}const i=this.getResolution();for(const s of e)if(!(t.x<s.x)){if(s.x+i<t.x||t.y<s.y||s.y+i<t.y)continue;return s}}getResolution(){return this.resolution}getViewCache(){return this.cellsViewCache}getDataset(t,e){return this}},Ft=class{constructor(t,e,i={}){if(i=i||{},this.resolutions=t,this.datasets=typeof e=="function"?this.resolutions.map(e):e,this.datasets.length>1&&this.datasets.length!=this.resolutions.length)throw new Error("Uncompatible number of datasets and resolutions: "+this.datasets.length+" "+this.resolutions.length);i.preprocess&&this.setPrepocesses(i.preprocess)}getDataset(t,e){if(this.datasets.length==1)return this.datasets[0];const i=this.resolutions;let s=0,n=i[s]/e;for(;n<t&&s<i.length;)s++,n=i[s]/e;return s==i.length?this.datasets[i.length-1]:this.datasets[s]}setPrepocesses(t){for(let e of this.datasets)e.preprocess=t;return this}},Pt=class extends O{constructor(t,e,i={}){super(t,e,0,i),this.info=void 0,this.infoLoadingStatus="notLoaded",this.cache={},this.loadInfo()}loadInfo(){return!this.info&&this.infoLoadingStatus==="notLoaded"?(async()=>{try{const t=await tt(this.url+"info.json");this.info=t,this.resolution=t.resolutionGeo,this.infoLoadingStatus="loaded",this.map.redraw()}catch{this.infoLoadingStatus="failed"}})():(this.infoLoadingStatus==="loaded"||this.infoLoadingStatus==="failed")&&this.map.redraw(),this}getTilingEnvelope(t){if(!this.info){this.loadInfo();return}const e=this.info.originPoint,i=this.info.resolutionGeo,s=this.info.tileSizeCell;return{xMin:Math.floor((t.xMin-e.x)/(i*s)),xMax:Math.floor((t.xMax-e.x)/(i*s)),yMin:Math.floor((t.yMin-e.y)/(i*s)),yMax:Math.floor((t.yMax-e.y)/(i*s))}}getData(t){if(!this.info)return this;const e=this.getTilingEnvelope(t);if(!e)return this;const i=this.info.tilingBounds;for(let s=Math.max(e.xMin,i.xMin);s<=Math.min(e.xMax,i.xMax);s++)for(let n=Math.max(e.yMin,i.yMin);n<=Math.min(e.yMax,i.yMax);n++)this.cache[s]||(this.cache[s]={}),!this.cache[s][n]&&(this.cache[s][n]="loading",(async()=>{let a;try{const c=await et(this.url+s+"/"+n+".csv");if(this.preprocess){a=[];for(const f of c)this.preprocess(f)!=!1&&a.push(f)}else a=c}catch{this.cache[s][n]="failed";return}if(!this.info){console.error("Tile info inknown");return}const o=Lt(a,s,n,this.info);this.cache[s][n]=o,this.map.redraw();let h=!1;const l=this.map.getZoom();for(const c of this.map.layers)if(!(c.visible&&!c.visible(l))&&c.getDataset&&c.getDataset(l)==this){h=!0;break}if(!h)return;const r=this.map.updateExtentGeo(),d=o.extGeo;r.xMax<=d.xMin||r.xMin>=d.xMax||r.yMax<=d.yMin||r.yMin>=d.yMax||this.map.redraw()})());return this}updateViewCache(t){if(this.cellsViewCache=[],!this.info)return;const e=this.getTilingEnvelope(t);if(!e)return;const i=this.info.tilingBounds;for(let s=Math.max(e.xMin,i.xMin);s<=Math.min(e.xMax,i.xMax);s++)if(this.cache[s])for(let n=Math.max(e.yMin,i.yMin);n<=Math.min(e.yMax,i.yMax);n++){const a=this.cache[s][n];if(!(!a||typeof a=="string"))for(const o of a.cells)+o.x+this.resolution<t.xMin||+o.x-this.resolution>t.xMax||+o.y+this.resolution<t.yMin||+o.y-this.resolution>t.yMax||this.cellsViewCache.push(o)}}};function Lt(x,t,e,i){const s={};s.cells=x,s.x=t,s.y=e;const n=i.resolutionGeo,a=i.tileSizeCell;s.extGeo={xMin:i.originPoint.x+n*a*s.x,xMax:i.originPoint.x+n*a*(s.x+1),yMin:i.originPoint.y+n*a*s.y,yMax:i.originPoint.y+n*a*(s.y+1)};for(let o of s.cells)o.x=s.extGeo.xMin+o.x*n,o.y=s.extGeo.yMin+o.y*n;return s}let At=class extends O{constructor(t,e,i,s={}){super(t,e,i,s),this.cells=[],this.delimiter=s.delimiter||",",this.infoLoadingStatus="notLoaded",this.getData(void 0)}getData(t){return this.infoLoadingStatus!="notLoaded"?this:(this.infoLoadingStatus="loading",(async()=>{try{const e=await mt(this.delimiter,this.url);for(const i of e)i.x=+i.x,i.y=+i.y;if(this.preprocess){this.cells=[];for(const i of e)this.preprocess(i)!=!1&&this.cells.push(i)}else this.cells=e;this.map&&this.map.redraw(),this.infoLoadingStatus="loaded"}catch{this.infoLoadingStatus="failed",this.cells=[]}})(),this)}updateViewCache(t){if(this.cells){this.cellsViewCache=[];for(const e of this.cells)+e.x+this.resolution<t.xMin||+e.x-this.resolution>t.xMax||+e.y+this.resolution<t.yMin||+e.y-this.resolution>t.yMax||this.cellsViewCache.push(e)}}};class Et extends O{constructor(t,e,i={}){super(void 0,"",t,i),this.cells=e||[]}getData(t){return this}updateViewCache(t){if(this.cells){this.cellsViewCache=[];for(const e of this.cells)+e.x+this.resolution<t.xMin||+e.x-this.resolution>t.xMax||+e.y+this.resolution<t.yMin||+e.y-this.resolution>t.yMax||this.cellsViewCache.push(e)}}}let It=class extends M{constructor(t){super(t),t=t||{},this.color=t.color||(()=>"#EA6BAC"),this.size=t.size||((e,i)=>i),this.shape=t.shape||(()=>"square")}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0,a=i*.5;for(let o of t){let h=this.color?this.color(o,i,s,n):"black";if(!h||h==="none")continue;const l=this.size?this.size(o,i,s,n):i;if(!l)continue;const r=this.shape?this.shape(o,i,s,n):"square";if(r==="none")continue;const d=this.offset(o,i,s);if(e.ctx.fillStyle=h,r==="square"){const c=i*(1-l/i)*.5;e.ctx.fillRect(o.x+c+d.dx,o.y+c+d.dy,l,l)}else if(r==="circle")e.ctx.beginPath(),e.ctx.arc(o.x+a+d.dx,o.y+a+d.dy,l*.5,0,2*Math.PI,!1),e.ctx.fill();else if(r==="donut"){const c=o.x+a+d.dx,f=o.y+a+d.dy;e.ctx.beginPath(),e.ctx.moveTo(c,f),e.ctx.arc(c,f,a,0,2*Math.PI),e.ctx.arc(c,f,(1-l/i)*a,0,2*Math.PI,!0),e.ctx.closePath(),e.ctx.fill()}else if(r==="diamond"){const c=l*.5;e.ctx.beginPath(),e.ctx.moveTo(o.x+a-c,o.y+a),e.ctx.lineTo(o.x+a,o.y+a+c),e.ctx.lineTo(o.x+a+c,o.y+a),e.ctx.lineTo(o.x+a,o.y+a-c),e.ctx.fill()}else if(r==="triangle_up"){const c=(l-i)/2;e.ctx.beginPath(),e.ctx.moveTo(o.x-c,o.y-c),e.ctx.lineTo(o.x+a,o.y+i+c),e.ctx.lineTo(o.x+i+c,o.y-c),e.ctx.fill()}else if(r==="triangle_down"){const c=(l-i)/2;e.ctx.beginPath(),e.ctx.moveTo(o.x-c,o.y+i+c),e.ctx.lineTo(o.x+a,o.y-c),e.ctx.lineTo(o.x+i+c,o.y+i+c),e.ctx.fill()}else if(r==="triangle_left"){const c=(l-i)/2;e.ctx.beginPath(),e.ctx.moveTo(o.x+i+c,o.y+i+c),e.ctx.lineTo(o.x-c,o.y+a),e.ctx.lineTo(o.x+i+c,o.y-c),e.ctx.fill()}else if(r==="triangle_right"){const c=(l-i)/2;e.ctx.beginPath(),e.ctx.moveTo(o.x-c,o.y-c),e.ctx.lineTo(o.x+i+c,o.y+a),e.ctx.lineTo(o.x-c,o.y+i+c),e.ctx.fill()}else throw new Error("Unexpected shape:"+r)}this.updateLegends({viewScale:n,resolution:i,z:s,cells:t})}},q=class extends M{constructor(t){super(t),t=t||{},this.strokeColor=t.strokeColor||(()=>"#666"),this.size=t.size||((e,i)=>i),this.strokeWidth=t.strokeWidth||((e,i,s)=>s*1.5),this.shape=t.shape||(()=>"square")}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0,a=i*.5;for(let o of t){const h=this.strokeColor?this.strokeColor(o,i,s,n):void 0;if(!h||h==="none")continue;e.ctx.strokeStyle=h;const l=this.size?this.size(o,i,s,n):i,r=this.strokeWidth?this.strokeWidth(o,i,s,n):1*s;if(!r||r<=0)continue;e.ctx.lineWidth=r;const d=this.shape?this.shape(o,i,s,n):"square";if(d==="none")continue;const c=this.offset(o,i,s);if(d==="square"){const f=i*(1-l/i)*.5;e.ctx.beginPath(),e.ctx.rect(o.x+f+c.dx,o.y+f+c.dy,l,l),e.ctx.stroke()}else if(d==="circle")e.ctx.beginPath(),e.ctx.arc(o.x+a+c.dx,o.y+a+c.dy,l*.5,0,2*Math.PI,!1),e.ctx.stroke();else if(d==="diamond"){const f=l*.5;e.ctx.beginPath(),e.ctx.moveTo(o.x+a-f,o.y+a),e.ctx.lineTo(o.x+a,o.y+a+f),e.ctx.lineTo(o.x+a+f,o.y+a),e.ctx.lineTo(o.x+a,o.y+a-f),e.ctx.lineTo(o.x+a-f,o.y+a),e.ctx.stroke()}else if(d==="donut")console.error("Not implemented");else if(d==="triangle_up"){const f=(l-i)/2;e.ctx.beginPath(),e.ctx.moveTo(o.x-f,o.y-f),e.ctx.lineTo(o.x+a,o.y+i+f),e.ctx.lineTo(o.x+i+f,o.y-f),e.ctx.closePath(),e.ctx.stroke()}else if(d==="triangle_down"){const f=(l-i)/2;e.ctx.beginPath(),e.ctx.moveTo(o.x-f,o.y+i+f),e.ctx.lineTo(o.x+a,o.y-f),e.ctx.lineTo(o.x+i+f,o.y+i+f),e.ctx.closePath(),e.ctx.stroke()}else if(d==="triangle_left"){const f=(l-i)/2;e.ctx.beginPath(),e.ctx.moveTo(o.x+i+f,o.y+i+f),e.ctx.lineTo(o.x-f,o.y+a),e.ctx.lineTo(o.x+i+f,o.y-f),e.ctx.closePath(),e.ctx.stroke()}else if(d==="triangle_right"){const f=(l-i)/2;e.ctx.beginPath(),e.ctx.moveTo(o.x-f,o.y-f),e.ctx.lineTo(o.x+i+f,o.y+a),e.ctx.lineTo(o.x-f,o.y+i+f),e.ctx.closePath(),e.ctx.stroke()}else throw new Error("Unexpected shape:"+d)}this.updateLegends({style:this,resolution:i,z:s,viewScale:n})}};class Rt extends M{constructor(t){super(t),t=t||{},this.height=t.height||((e,i)=>i*Math.random()),this.lineColor=t.lineColor||((e,i,s,n)=>"#BBB"),this.lineWidth=t.lineWidth||((e,i,s,n)=>n),this.fillColor=t.fillColor||((e,i,s,n)=>"#c08c5968")}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0,a={};for(const f of t){let u=a[f.y];u||(u={},a[f.y]=u),u[f.x]=this.height(f,i,s,n)}const o=e.extGeo;if(!o)return;const h=Math.floor(o.xMin/i)*i,l=Math.floor(o.xMax/i)*i,r=Math.floor(o.yMin/i)*i,d=Math.floor(o.yMax/i)*i,c={min:r,max:d};e.ctx.lineJoin="round";for(let f=d;f>=r;f-=i){const u=a[f];if(!u)continue;e.ctx.beginPath(),e.ctx.moveTo(h-i/2,f);let g;for(let m=h;m<=l;m+=i){let w=u[m];w||(w=0),w||g?e.ctx.lineTo(m+i/2,f+w):e.ctx.moveTo(m+i/2,f),g=w}g&&e.ctx.lineTo(l+i/2,f);const p=this.fillColor(f,c,i,s);p&&p!="none"&&(e.ctx.fillStyle=p,e.ctx.fill());const y=this.lineColor(f,c,i,s),v=this.lineWidth(f,c,i,s);y&&y!="none"&&v>0&&(e.ctx.strokeStyle=y,e.ctx.lineWidth=v,e.ctx.stroke())}}}class Bt extends M{constructor(t){super(t),t=t||{},this.color=t.color,this.type=t.type||(()=>"flag"),this.size=t.size||((e,i)=>i),this.stripesOrientation=t.stripesOrientation||(()=>0),this.offsetAngle=t.offsetAngle||(()=>0),this.agePyramidHeight=t.agePyramidHeight||((e,i)=>i),this.pieChartInternalRadiusFactor=t.pieChartInternalRadiusFactor||0}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0,a=Object.entries(this.color).length;for(let o of t){const h=this.size?this.size(o,i,s,n):i;if(!h)continue;const l=this.offset(o,i,s),r=this.type?this.type(o,i,s,n):"flag",d=o.x+l.dx+(r==="agepyramid"?0:i*.5),c=o.y+l.dy+(r==="agepyramid"?0:i*.5),f=this.offsetAngle?this.offsetAngle(o,i,s,n)*Math.PI/180:0;if(r==="agepyramid"||r==="radar"||r==="halftone"){let u=-1/0;for(let y of Object.keys(this.color)){const v=+o[y];v>u&&(u=v)}let g=0;r==="agepyramid"&&this.agePyramidHeight&&(g=(i-this.agePyramidHeight(o,i,s,n))/2),(r==="radar"||r==="halftone")&&(g=Math.PI/2+f);const p=r==="agepyramid"?(this.agePyramidHeight?this.agePyramidHeight(o,i,s,n):i)/a:r==="radar"||r==="halftone"?2*Math.PI/a:void 0;if(p===void 0)throw new Error("Unexpected symbol type:"+r);for(let[y,v]of Object.entries(this.color))if(r==="agepyramid"){e.ctx.fillStyle=v;const m=o[y],w=h*m/u;e.ctx.fillRect(d+(i-w)/2,c+g,w,p),g+=p}else if(r==="radar"){e.ctx.fillStyle=v;const m=o[y],w=h/2*Math.sqrt(m/u);e.ctx.beginPath(),e.ctx.moveTo(d,c),e.ctx.arc(d,c,w,g-p,g),e.ctx.lineTo(d,c),e.ctx.fill(),g+=p}else if(r==="halftone"){e.ctx.fillStyle=v;const m=o[y],w=h*.333*Math.sqrt(m/u);e.ctx.beginPath(),e.ctx.arc(d+i*.25*Math.cos(g),c+i*.25*Math.sin(g),w,0,2*Math.PI),e.ctx.fill(),g+=p}else throw new Error("Unexpected symbol type:"+r)}else{let u=0;for(let v of Object.keys(this.color)){const m=+o[v];m&&(u+=m)}if(!u||isNaN(u))continue;let g=0;const p=i*(1-h/i)*.5,y=this.stripesOrientation(o,i,s,n);for(let[v,m]of Object.entries(this.color)){const w=o[v]/u;if(!(!w||isNaN(w))){if(e.ctx.fillStyle=m,r==="flag")y==0?e.ctx.fillRect(o.x+p+l.dx,o.y+p+g*h+l.dy,h,w*h):e.ctx.fillRect(o.x+p+g*h+l.dx,o.y+p+l.dy,w*h,h);else if(r==="piechart"){const b=g*2*Math.PI,S=(g+w)*2*Math.PI;e.ctx.beginPath(),e.ctx.moveTo(d,c),e.ctx.arc(d,c,h*.5,b+f,S+f),this.pieChartInternalRadiusFactor&&e.ctx.arc(d,c,h*.5*this.pieChartInternalRadiusFactor,b+f,S+f,!0),e.ctx.closePath(),e.ctx.fill()}else if(r==="ring")e.ctx.beginPath(),e.ctx.arc(d,c,Math.sqrt(1-g)*h*.5,0,2*Math.PI),e.ctx.fill();else if(r==="segment"){const b=h*h/i;y==0?e.ctx.fillRect(o.x+l.dx,o.y+(i-b)/2+g*b+l.dy,i,w*b):e.ctx.fillRect(o.x+g*i+l.dx,o.y+(i-b)/2+l.dy,w*i,b)}else throw new Error("Unexpected symbol type:"+r);g+=w}}}}this.updateLegends({style:this,resolution:i,z:s,viewScale:n})}}let Wt=class extends M{constructor(t){super(t),t=t||{},this.color=t.color||(()=>"#EA6BAC"),this.width=t.width||((e,i)=>i*.1),this.length=t.length||((e,i)=>i*.9),this.orientation=t.orientation||(()=>180*Math.random())}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0;e.ctx.lineCap="butt";const a=Math.PI/180;for(let o of t){const h=this.color?this.color(o,i,s,n):void 0;if(!h)continue;const l=this.width?this.width(o,i,s,n):void 0;if(!l||l<0)continue;const r=this.length?this.length(o,i,s,n):void 0;if(!r||r<0)continue;const d=this.orientation(o,i,s,n)*a;if(d===void 0||isNaN(d))continue;const c=this.offset(o,i,s);e.ctx.strokeStyle=h,e.ctx.lineWidth=l;const f=o.x+i/2+c.dx,u=o.y+i/2+c.dy,g=.5*Math.cos(d)*r,p=.5*Math.sin(d)*r;e.ctx.beginPath(),e.ctx.moveTo(f-g,u-p),e.ctx.lineTo(f+g,u+p),e.ctx.stroke()}this.updateLegends({viewScale:n,resolution:i,z:s,cells:t})}};class Dt extends M{constructor(t){super(t),t=t||{},this.text=t.text||(()=>"X"),this.color=t.color||(()=>"black"),this.fontSize=t.fontSize||((e,i)=>i),this.fontFamily=t.fontFamily||(()=>"Arial"),this.fontWeight=t.fontWeight||(()=>"bold")}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0;e.initCanvasTransform();for(let a of t){const o=this.text?this.text(a,i,s,n):void 0;if(o==null||o==null||o+""=="")continue;const h=this.color?this.color(a,i,s,n):void 0;if(!h)continue;e.ctx.fillStyle=h;const l=this.fontSize(a,i,s,n)/s;if(!l)continue;const r=this.fontFamily?this.fontFamily(a,i,s,n):"Arial",d=this.fontWeight?this.fontWeight(a,i,s,n):"bold";e.ctx.font=d+" "+l+"px "+r;const c=this.offset(a,i,s);e.ctx.textAlign="center";const f=e.geoToPixX(a.x+i*.5+c.dx),u=e.geoToPixY(a.y+i*.5+c.dy)+l*.3;e.ctx.fillText(o,f,u)}this.updateLegends({style:this,resolution:i,z:s,viewScale:n})}static textScale(t,e=void 0){const i=t.length;return s=>(e&&(s=e(s)),s==0?"":s>=1?t[i-1]:t[Math.floor(s*i)])}}let Gt=class extends M{constructor(t){super(t),t=t||{},this.height=t.height,this.color=t.color||(()=>"#c08c59"),this.width=t.width||((e,i)=>.5*i),this.simple=t.simple||(()=>!1),this.viewHeightFactor=t.viewHeightFactor||1.5,this.viewSX=t.viewSX==null?0:t.viewSX,this.viewSY=t.viewSY==null?-.5:t.viewSY,this.shadowDirection=t.shadowDirection==null?-40.3*Math.PI/180:t.shadowDirection,this.shadowFactor=t.shadowFactor||.3,this.shadowColor=t.shadowColor||"#00000033",this.outlineCol=t.outlineCol||"#FFFFFF",this.outlineWidthPix=t.outlineWidthPix==null?.5:t.outlineWidthPix}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0,a=e.view.x+this.viewSX*e.w*s,o=e.view.y+this.viewSY*e.h*s,h=this.viewHeightFactor*(e.w+e.h)*.5*s;t.sort((r,d)=>1e8*(d.y-r.y)+r.x-d.x);const l=this.simple(i,s,n);e.ctx.lineCap=l?"butt":"round",e.ctx.strokeStyle=this.shadowColor,e.ctx.fillStyle=this.shadowColor;for(let r of t){const d=this.width?this.width(r,i,s,n):void 0;if(!d||d<0)continue;const c=this.height?this.height(r,i,s,n):void 0;if(!c||c<0)continue;e.ctx.lineWidth=d;const f=r.x+i/2,u=r.y+i/2,g=c*this.shadowFactor;e.ctx.beginPath(),e.ctx.moveTo(f,u),e.ctx.lineTo(f+g*Math.cos(this.shadowDirection),u+g*Math.sin(this.shadowDirection)),e.ctx.stroke()}for(let r of t){const d=this.color?this.color(r,i,s,n):void 0;if(!d)continue;const c=this.width?this.width(r,i,s,n):void 0;if(!c||c<0)continue;const f=this.height?this.height(r,i,s,n):void 0;if(!f||f<0)continue;const u=r.x+i/2,g=r.y+i/2,p=u-a,y=g-o,v=Math.atan2(y,p),m=Math.sqrt(p*p+y*y)*f/(h-f);l?(e.ctx.strokeStyle=d,e.ctx.lineWidth=c,e.ctx.beginPath(),e.ctx.moveTo(u,g),e.ctx.lineTo(u+m*Math.cos(v),g+m*Math.sin(v)),e.ctx.stroke()):(e.ctx.strokeStyle=this.outlineCol,e.ctx.lineWidth=c+2*this.outlineWidthPix*s,e.ctx.beginPath(),e.ctx.moveTo(u,g),e.ctx.lineTo(u+m*Math.cos(v),g+m*Math.sin(v)),e.ctx.stroke(),e.ctx.strokeStyle=d,e.ctx.lineWidth=c,e.ctx.beginPath(),e.ctx.moveTo(u,g),e.ctx.lineTo(u+m*Math.cos(v),g+m*Math.sin(v)),e.ctx.stroke(),e.ctx.strokeStyle=this.outlineCol,e.ctx.lineWidth=this.outlineWidthPix*s,e.ctx.beginPath(),e.ctx.arc(u+m*Math.cos(v),g+m*Math.sin(v),c*.5,0,2*Math.PI,!1),e.ctx.stroke())}e.ctx.lineCap="butt",this.updateLegends({style:this,resolution:i,z:s,viewScale:n})}};class L extends M{constructor(t={}){super(t),this.color=t.color||((e,i,s,n)=>"#EA6BAC"),this.width=t.width||((e,i,s,n)=>i/5),this.length=t.length||((e,i,s,n)=>i),this.diamond=t.diamond}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=L.buildSides(t,i);if(n.length==0)return;const a=this.viewScale?this.viewScale(n,i,s):void 0;e.ctx.lineCap="butt";const o=i*.5;for(let h of n){const l=this.color?this.color(h,i,s,a):void 0;if(!(!l||l=="none"))if(this.diamond){e.ctx.fillStyle=l;const r=h.x,d=h.y;e.ctx.beginPath(),e.ctx.moveTo(r-o,d),e.ctx.lineTo(r,d+o),e.ctx.lineTo(r+o,d),e.ctx.lineTo(r,d-o),e.ctx.closePath(),e.ctx.fill()}else{const r=this.width?this.width(h,i,s,a):void 0;if(!r||r<=0)continue;const d=this.length?this.length(h,i,s,a):void 0;if(!d||d<=0)continue;const c=d*.5;e.ctx.lineWidth=r,e.ctx.strokeStyle=l;const f=h.x,u=h.y;e.ctx.beginPath(),h.or==="v"?(e.ctx.moveTo(f,u-c),e.ctx.lineTo(f,u+c)):(e.ctx.moveTo(f-c,u),e.ctx.lineTo(f+c,u)),e.ctx.stroke()}}this.updateLegends({style:this,resolution:i,z:s,viewScale:a})}static buildSides(t,e,i=!0,s=!0,n=!0){const a=[],o=n?e/2:0;t.sort((l,r)=>r.x==l.x?l.y-r.y:l.x-r.x);let h=t[0];for(let l=1;l<t.length;l++){let r=t[l];h.y+e==r.y&&h.x==r.x?a.push({or:"h",x:h.x+o,y:r.y,c1:h,c2:r}):(a.push({or:"h",x:h.x+o,y:h.y+e,c1:h,c2:void 0}),a.push({or:"h",x:r.x+o,y:r.y,c1:void 0,c2:r})),h=r}t.sort((l,r)=>r.y==l.y?l.x-r.x:l.y-r.y),h=t[0];for(let l=1;l<t.length;l++){let r=t[l];h.x+e==r.x&&h.y==r.y?a.push({or:"v",x:h.x+e,y:h.y+o,c1:h,c2:r}):(a.push({or:"v",x:h.x+e,y:h.y+o,c1:h,c2:void 0}),a.push({or:"v",x:r.x,y:r.y+o,c1:void 0,c2:r})),h=r}return a}}let Ot=class extends L{constructor(t){super(t),t=t||{},this.code=t.code,this.color=t.color}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=L.buildSides(t,i);if(n.length==0)return;const a=this.viewScale?this.viewScale(n,i,s):void 0;e.ctx.lineCap="butt";const o=i*.5;for(let h of n){const l=h.c1?this.code(h.c1,i,s):void 0,r=h.c2?this.code(h.c2,i,s):void 0;if(l==r)continue;const d=this.width?this.width(h,i,s,a):void 0;if(!d||d<=0)continue;const c=d*.5;e.ctx.lineWidth=d,h.or==="h"?(r&&(e.ctx.beginPath(),e.ctx.strokeStyle=this.color[r],e.ctx.moveTo(h.x-o,h.y+c),e.ctx.lineTo(h.x+o,h.y+c),e.ctx.stroke()),l&&(e.ctx.beginPath(),e.ctx.strokeStyle=this.color[l],e.ctx.moveTo(h.x-o,h.y-c),e.ctx.lineTo(h.x+o,h.y-c),e.ctx.stroke())):(r&&(e.ctx.beginPath(),e.ctx.strokeStyle=this.color[r],e.ctx.moveTo(h.x+c,h.y-o),e.ctx.lineTo(h.x+c,h.y+o),e.ctx.stroke()),l&&(e.ctx.beginPath(),e.ctx.strokeStyle=this.color[l],e.ctx.moveTo(h.x-c,h.y-o),e.ctx.lineTo(h.x-c,h.y+o),e.ctx.stroke()))}this.updateLegends({style:this,resolution:i,z:s,viewScale:a})}};function X(x,t,e={}){const i=document.createElement("canvas");i.setAttribute("width",x),i.setAttribute("height",t);const s=i.getContext("webgl",e);if(!s)throw new Error("Unable to initialize WebGL. Your browser or machine may not support it.");return{canvas:i,gl:s}}function j(x,...t){const e=x.createProgram();if(e==null)throw new Error("Cannot create webGL program");for(const i of t)x.attachShader(e,i);if(x.linkProgram(e),x.getProgramParameter(e,x.LINK_STATUS))return e;throw new Error(x.getProgramInfoLog(e)||"Cannot create webGL program (2)")}function A(x,t,...e){const i=x.createShader(t);if(i==null)throw new Error("Cannot create webGL shader");if(x.shaderSource(i,e.join(`
`)),x.compileShader(i),x.getShaderParameter(i,x.COMPILE_STATUS))return i;throw new Error(x.getShaderInfoLog(i)||"Cannot create webGL shader (2)")}function Nt(){try{const x=document.createElement("canvas");return!!(window.WebGLRenderingContext&&(x.getContext("webgl")||x.getContext("experimental-webgl")))}catch{return!1}}let Ht=class{constructor(t,e){this.gl=t,this.sizePix=e||10,this.program=j(t,A(t,t.VERTEX_SHADER,`
            attribute vec2 pos;
            uniform float sizePix;
            uniform mat3 mat;
            attribute vec4 color;
            varying vec4 vColor;
            void main() {
              gl_Position = vec4(mat * vec3(pos, 1.0), 1.0);
              gl_PointSize = sizePix;
              vColor = color;
            }
          `),A(t,t.FRAGMENT_SHADER,`
            precision mediump float;
            varying vec4 vColor;
            void main(void) {
                vec4 vColor_ = vColor / 255.0;
                vColor_[3] = 255.0 * vColor_[3];
                gl_FragColor = vColor_;
            }`)),t.useProgram(this.program),this.verticesBuffer=[],this.colorsBuffer=[]}addPointData(t,e,i){const s=G(i);s&&(this.verticesBuffer.push(t,e),this.colorsBuffer.push(s.r,s.g,s.b,s.opacity))}addPointData2(t,e,i,s,n,a){this.verticesBuffer.push(t,e),this.colorsBuffer.push(i,s,n,a)}draw(t){const e=this.gl;e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.verticesBuffer),e.STATIC_DRAW);const i=e.getAttribLocation(this.program,"pos");e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(i),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.colorsBuffer),e.STATIC_DRAW);var s=e.getAttribLocation(this.program,"color");e.vertexAttribPointer(s,4,e.FLOAT,!1,0,0),e.enableVertexAttribArray(s),e.uniform1f(e.getUniformLocation(this.program,"sizePix"),1*this.sizePix),e.uniformMatrix3fv(e.getUniformLocation(this.program,"mat"),!1,new Float32Array(t)),e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.POINTS,0,this.verticesBuffer.length/2)}},Ut=class extends M{constructor(t){super(t),t=t||{},this.dotNumber=t.dotNumber||((e,i)=>i/100),this.color=t.color||(()=>"#FF5733"),this.dotSize=t.dotSize||((e,i)=>1.5*i),this.sigma=t.sigma||((e,i)=>e/2)}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0,a=this.dotSize?this.dotSize(i,s,n):s,o=this.sigma?this.sigma(i,s,n):i*.4,h=wt(0,o);if(Nt()){const l=X(e.w+"",e.h+"");if(!l){console.error("No webGL");return}const r=new Ht(l.gl,a/s),d=i/2;for(let c of t){const f=this.color(c,i,s,n);if(!f||f==="none")continue;const u=this.dotNumber(c,i,s,n),g=this.offset(c,i,s),p=c.x+g.dx+d,y=c.y+g.dy+d,v=G(f);if(!v)return;for(let m=0;m<=u;m++)r.addPointData2(p+h(),y+h(),v.r,v.g,v.b,v.opacity)}r.draw(e.getWebGLTransform()),e.initCanvasTransform(),e.ctx.drawImage(l.canvas,0,0)}else for(let l of t){const r=this.color(l,i,s,n);if(!r||r==="none")continue;e.ctx.fillStyle=r;const d=this.dotNumber(l,i,s,n),c=this.offset(l,i,s),f=l.x+c.dx+i/2,u=l.y+c.dy+i/2;for(let g=0;g<=d;g++)e.ctx.fillRect(f+h(),u+h(),a,a)}this.updateLegends({style:this,resolution:i,z:s,viewScale:n})}},_t=class{constructor(t){this.colors=t,this.vshString=`
        attribute vec2 pos;
        uniform float sizePix;
        uniform mat3 mat;

        attribute float i;
        varying float vi;

        void main() {
          gl_Position = vec4(mat * vec3(pos, 1.0), 1.0);
          gl_PointSize = sizePix;
          vi = i;
        }
        `;const e=[];e.push(`precision mediump float;
varying float vi;
`),e.push("uniform vec4");for(let i=0;i<t.length;i++)i>0&&e.push(","),e.push(" c"+i);e.push(`;
`),e.push(`void main(void) {
`);for(let i=0;i<t.length;i++)i>0&&e.push("else "),e.push("if(vi=="),e.push(i),e.push(".0) gl_FragColor = vec4(c"),e.push(i),e.push("[0], c"),e.push(i),e.push("[1], c"),e.push(i),e.push("[2], c"),e.push(i),e.push(`[3]);
`);e.push(`else gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
}`),this.fshString=e.join("")}draw(t,e,i,s,n=10){const a=A(t,t.VERTEX_SHADER,this.vshString),o=A(t,t.FRAGMENT_SHADER,this.fshString),h=j(t,a,o);t.useProgram(h),t.uniform1f(t.getUniformLocation(h,"sizePix"),1*n);for(let d=0;d<this.colors.length;d++){const c=G(this.colors[d]);t.uniform4fv(t.getUniformLocation(h,"c"+d),[+c.r/255,+c.g/255,+c.b/255,+c.opacity])}t.bindBuffer(t.ARRAY_BUFFER,t.createBuffer()),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW);const l=t.getAttribLocation(h,"pos");t.vertexAttribPointer(l,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(l),t.bindBuffer(t.ARRAY_BUFFER,t.createBuffer()),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW);const r=t.getAttribLocation(h,"i");t.vertexAttribPointer(r,1,t.FLOAT,!1,0,0),t.enableVertexAttribArray(r),t.uniformMatrix3fv(t.getUniformLocation(h,"mat"),!1,new Float32Array(s)),t.clear(t.COLOR_BUFFER_BIT),t.drawArrays(t.POINTS,0,e.length/2)}},J=class extends M{constructor(t){super(t),t=t||{},this.code=t.code,t.color=t.color||void 0;const e=Object.keys(t.color);this.catToI={};for(let i=0;i<e.length;i++)this.catToI[e[i]]=i+"";this.colors=[];for(const i of e)this.colors.push(t.color[""+i]);this.size=t.size,this.wgp=new _t(this.colors)}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=i/2;let a,o=t.length;const h=[],l=[];for(let c=0;c<o;c++){a=t[c];const f=this.code(a);if(f==null){console.log("Unexpected category: "+f);continue}const u=this.catToI[f];if(isNaN(+u)){console.log("Unexpected category index: "+f+" "+u);continue}h.push(a.x+n,a.y+n),l.push(+u)}const r=X(e.w+"",e.h+"");if(!r){console.error("No webGL");return}const d=this.size?this.size(i,s):i+.2*s;this.wgp.draw(r.gl,h,l,e.getWebGLTransform(),d/s),e.initCanvasTransform(),e.ctx.drawImage(r.canvas,0,0),this.updateLegends({style:this,resolution:i,z:s})}};const Vt=x=>{const t=x.valueFunction,e=x.minValue||0,i=x.minSizePix||0,s=x.maxSizeFactor||1,n=x.stretching,a=x.range,o=x.domain,h=x.classNumber;return(l,r,d)=>{const c=o||[e,it(l,t)],f=a||[i*d,r*s],u=c[1]-c[0],g=c[0],p=f[1]-f[0],y=f[0];return v=>(v=(v-g)/u,n&&(v=n(v)),h&&(v=v==1?1:Math.floor(v*h)/(h-1)),y+v*p)}},$t=x=>{const t=x.valueFunction,e=x.classNumber||12,i=x.minSizePix||1,s=x.maxSizeFactor||1,n=st();return(a,o,h)=>{n.domain(a.map(t));const l=i*h,r=o*s;return n.range(Array.from({length:e},(d,c)=>l+c*(r-l)/(e-1))),n.breaks=n.quantiles(),n.values=n.range(),n}},Yt=x=>{const t=x.valueFunction,e=x.stretching;let i=x.colorScale||(()=>"purple");const s=x.colors?.length;return x.colors&&s&&(i=n=>x.colors[n==1?s-1:Math.floor(n*s)]),n=>{if(n.length==0||!n)return;const a=bt(n,t);if(a[0]==null)return;const o=a[1]-a[0],h=l=>(l=(l-a[0])/o,e&&(l=e(l)),i(l));if(h.invert=l=>(e&&(l=e.invert(l)),a[0]+l*o),x.colors&&s){h.breaks=[];for(let l=1;l<s;l++)h.breaks.push(h.invert(l/s))}return h}},Zt=x=>{const t=x.valueFunction,e=x.classNumber||12;let i=x.colors;x.colorScale&&(i=rt(x.colorScale,e)),i=i||Array.from({length:e},(n,a)=>"rgb("+Math.floor(255*a/(e-1))+",150,150)");const s=st().range(i);return n=>(s.domain(n.map(t)),s.breaks=s.quantiles(),s.colors=i,s)},qt=x=>(t,e,i)=>{const s={};for(const n in x)s[n]=x[n](t,e,i);return s};function Q(x){const t=x.length,e=i=>{let s=0;for(;s<t;){const n=x[s];if(i<=n)return s;s++}return s};return e.breaks=x,e}function Xt(x,t){const e=Q(x),i=s=>t[e(s)];return i.breaks=x,i.colors=t,i}function rt(x,t){if(t==1)return[x(.5)];const e=[];for(let i=0;i<t;i++)e.push(x(i/(t-1)));return e}class at{static get(t,e,i,s={}){s.colorDark=s.colorDark||"#111",s.colorBright=s.colorBright||"#ddd",s.width=s.width||((r,d,c)=>{const f=1*c,u=4*c,g=(u-f)/3;return Math.min(f+(r-1)*g,u)});const n=Q(e),a={};for(let r=0;r<i.length;r++)a[r+""]=i[r];const o=new J({code:r=>n(t(r)),color:a}),h=r=>{const d=r.c1?n(t(r.c1)):-1,c=r.c2?n(t(r.c2)):-1;return d-c},l=new L({color:r=>{const d=h(r);if(d!==0)return r.or==="v"?d<0?s.colorBright:s.colorDark:d<0?s.colorDark:s.colorBright},width:(r,d,c)=>s.width(Math.abs(h(r)),d,c)});return[o,l]}}class jt{static get(t,e,i,s={}){s=s||{},s.colDark=s.colDark||"#333",s.colBright=s.colBright||"#aaa",s.widthFactor=s.widthFactor||.12;const n=at.get(t,e,i,s),a=new q({strokeColor:()=>"#666",strokeWidth:(o,h,l)=>.2*l,filter:s.filter});return[n[0],a,n[1],new lt({colDark:s.colDark,colBright:s.colBright,filter:s.filter})]}static getCategory(t,e,i){i=i||{},i.colDark=i.colDark||"#333",i.colBright=i.colBright||"#aaa";const s=new J({code:t,color:e}),n=new q({strokeColor:()=>"#666",strokeWidth:(a,o,h)=>.2*h});return[s,n,new lt({colDark:i.colDark,colBright:i.colBright})]}}let lt=class extends M{constructor(t){super(t),t=t||{},this.colDark=t.colDark||"#333",this.colBright=t.colBright||"#aaa"}draw(t,e,i){this.filter&&(t=t.filter(this.filter)),e.ctx.lineWidth=.6*e.view.z,e.ctx.strokeStyle=this.colDark;for(let s of t)e.ctx.beginPath(),e.ctx.arc(s.x+i*.5,s.y+i*.5,i*.55*.5,Math.PI/4,-Math.PI*(3/4),!0),e.ctx.stroke();e.ctx.strokeStyle=this.colBright;for(let s of t)e.ctx.beginPath(),e.ctx.arc(s.x+i*.5,s.y+i*.5,i*.55*.5,Math.PI/4,-Math.PI*(3/4),!1),e.ctx.stroke()}};class Jt{constructor(t,e,i,s=10,n=void 0){this.gl=t;const a=A(t,t.VERTEX_SHADER,`
        attribute vec2 pos;
        uniform float sizePix;
        uniform mat3 mat;

        attribute float t;
        varying float vt;

        void main() {
          gl_Position = vec4(mat * vec3(pos, 1.0), 1.0);
          gl_PointSize = sizePix;
          vt = t;
        }
      `);let o=`precision mediump float;
varying float vt;
uniform float alpha;
`+(()=>{const l=[];for(let r=0;r<e.length;r++)l.push("uniform vec4 c"+r+`;
`);return l.join("")})()+`void main(void) {
`;if(i?i.fun=="pow"?o+=`   float t = pow(vt, alpha);
`:i.fun=="powInv"?o+=`   float t = 1.0-pow(1.0-vt, 1.0/alpha);
`:i.fun=="exp"?o+=i.alpha==0?"float t = vt;":`   float t = (exp(vt * alpha) - 1.0) / (exp(alpha) - 1.0);
`:i.fun=="log"?o+=i.alpha==0?"float t = vt;":`   float t = 1.0 - (1.0 / alpha) * log(exp(alpha) * (1.0 - vt) + vt);
`:i.fun=="circle"?i.alpha==0?o+=`   float t = vt;
`:i.alpha==1?o+=`   float t = sqrt(vt * (2.0 - vt));
`:o+=`   float a = alpha / (1.0 - alpha);
   float t = sqrt(1.0 / (a * a) + vt * ( 2.0/a + 2.0 - vt )) - 1.0 / a;
`:i.fun=="circleInv"?i.alpha==0?o+=`   float t = vt;
`:i.alpha==1?o+=`   float t = 1.0 - sqrt((1.0 - vt) * (1.0 + vt));
`:o+=`   float a = alpha / (1.0 - alpha);
   float t = 1.0 - sqrt(1.0 / (a * a) + (1.0-vt) * ( 2.0/a + 1.0 + vt )) + 1.0 / a;
`:(console.error("Unexpected stretching function code: "+i.fun),o+=`   float t = vt;
`):o+=`   float t = vt;
`,e.length==1)o+=`   vec4 cI=c0;
   vec4 cF=c0;
`;else if(e.length==2)o+=`   vec4 cI=c0;
   vec4 cF=c1;
`;else{const l=e.length-1,r=l+".0";o+=`   vec4 cI;
`,o+=`   vec4 cF;
`,o+="   if(t<1.0/"+r+") { cI=c0; cF=c1; t=t*"+r+`; }
`;for(let d=2;d<l;d++)o+="   else if(t<"+d+".0/"+r+") { cI=c"+(d-1)+"; cF=c"+d+"; t="+r+"*t-"+(d-1)+`.0; }
`;o+="   else { cI=c"+(l-1)+"; cF=c"+l+"; t="+r+"*t-"+(l-1)+`.0; }
`}e.length==1?o+=`   gl_FragColor = vec4(c0[0], c0[1], c0[2], c0[3]);}
`:o+=`   gl_FragColor = mix(cI, cF, t);}
`;const h=A(t,t.FRAGMENT_SHADER,o);this.program=j(t,a,h),t.useProgram(this.program),t.uniform1f(t.getUniformLocation(this.program,"sizePix"),1*s),t.uniform1f(t.getUniformLocation(this.program,"alpha"),i?1*i.alpha:0);for(let l=0;l<e.length;l++){const r=G(e[l]);let d=r.opacity;r.opacity==1&&n!=null&&(d=n),t.uniform4fv(t.getUniformLocation(this.program,"c"+l),[+r.r/255,+r.g/255,+r.b/255,+d])}}draw(t,e,i){const s=this.gl,n=this.program;s.bindBuffer(s.ARRAY_BUFFER,s.createBuffer()),s.bufferData(s.ARRAY_BUFFER,new Float32Array(t),s.STATIC_DRAW);const a=s.getAttribLocation(n,"pos");s.vertexAttribPointer(a,2,s.FLOAT,!1,0,0),s.enableVertexAttribArray(a),s.bindBuffer(s.ARRAY_BUFFER,s.createBuffer()),s.bufferData(s.ARRAY_BUFFER,new Float32Array(e),s.STATIC_DRAW);const o=s.getAttribLocation(n,"t");s.vertexAttribPointer(o,1,s.FLOAT,!1,0,0),s.enableVertexAttribArray(o),s.uniformMatrix3fv(s.getUniformLocation(n,"mat"),!1,new Float32Array(i)),s.clear(s.COLOR_BUFFER_BIT),s.drawArrays(s.POINTS,0,t.length/2)}}let Qt=class extends M{constructor(t){super(t),t=t||{},this.tFun=t.tFun,this.stretching=t.stretching,this.colors=t.colors||["rgb(158, 1, 66)","rgb(248, 142, 83)","rgb(251, 248, 176)","rgb(137, 207, 165)","rgb(94, 79, 162)"].reverse(),t.color&&(this.colors=[t.color(0),t.color(.2),t.color(.4),t.color(.6),t.color(.8),t.color(1)]),this.opacity=t.opacity,this.size=t.size}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0,a=X(e.w+"",e.h+"",this.opacity!=null?{premultipliedAlpha:!1}:void 0);if(!a){console.error("No webGL");return}const o=i/2,h=[],l=[];for(let c of t){const f=this.tFun(c,i,s,n);f==null||f==null||(h.push(c.x+o,c.y+o),l.push(f>1?1:f<0?0:f))}const r=this.size?this.size(i,s):i+.2*s,d=this.opacity?this.opacity(i,s):void 0;new Jt(a.gl,this.colors,this.stretching,r/s,d).draw(h,l,e.getWebGLTransform()),e.initCanvasTransform(),e.ctx.drawImage(a.canvas,0,0),this.updateLegends({style:this,resolution:i,z:s,viewScale:n})}},Kt=class extends M{constructor(t){super(t),t=t||{},this.color=t.color||(()=>"#EA6BAC"),this.mosaicFactor=t.mosaicFactor||.15,this.shadowFactor=t.shadowFactor||.2,this.shadowColor=t.shadowColor||"#555"}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0;e.ctx.strokeStyle=this.shadowColor,e.ctx.lineWidth=this.shadowFactor*i,e.ctx.lineJoin="round",e.ctx.lineCap="butt";const a=i*this.mosaicFactor,o=()=>({x:Math.random()*a,y:Math.random()*a});for(let h of t){const l=this.color?this.color(h,i,s,n):void 0;if(!l||l==="none")continue;e.ctx.fillStyle=l;const r=this.offset(h,i,s),d=o(),c=o(),f=o(),u=o();this.shadowFactor>0&&(e.ctx.beginPath(),e.ctx.moveTo(h.x+r.dx+d.x,h.y+r.dy+d.y),e.ctx.lineTo(h.x+r.dx+i-f.x,h.y+r.dy+f.y),e.ctx.lineTo(h.x+r.dx+i-u.x,h.y+r.dy+i-u.y),e.ctx.stroke()),e.ctx.beginPath(),e.ctx.moveTo(h.x+r.dx+d.x,h.y+r.dy+d.y),e.ctx.lineTo(h.x+r.dx+i-f.x,h.y+r.dy+f.y),e.ctx.lineTo(h.x+r.dx+i-u.x,h.y+r.dy+i-u.y),e.ctx.lineTo(h.x+r.dx+c.x,h.y+r.dy+i-c.y),e.ctx.fill()}this.updateLegends({style:this,resolution:i,z:s,viewScale:n})}},te=class extends M{constructor(t){super(t),t=t||{},this.color=t.color||(()=>"#EA6BAC"),this.size=t.size||((e,i)=>i),this.shape=t.shape||(()=>"o")}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0,a=i*.5;for(let o of t){const h=this.color?this.color(o,i,s,n):void 0;if(!h||h==="none")continue;e.ctx.fillStyle=h;let l=this.size(o,i,s,n);l=l<0?0:l>1?1:l;const r=l*a,d=this.shape?this.shape(o):"o";if(d==="none")continue;const c=o.x+a,f=o.y+a;if(d==="p")e.ctx.beginPath(),e.ctx.moveTo(c,f+a),e.ctx.lineTo(c+r,f+r),e.ctx.lineTo(c+a,f),e.ctx.lineTo(c+r,f-r),e.ctx.lineTo(c,f-a),e.ctx.lineTo(c-r,f-r),e.ctx.lineTo(c-a,f),e.ctx.lineTo(c-r,f+r),e.ctx.fill();else if(d==="o")e.ctx.beginPath(),e.ctx.moveTo(c,f+r),e.ctx.lineTo(c+a,f+a),e.ctx.lineTo(c+r,f),e.ctx.lineTo(c+a,f-a),e.ctx.lineTo(c,f-r),e.ctx.lineTo(c-a,f-a),e.ctx.lineTo(c-r,f),e.ctx.lineTo(c-a,f+a),e.ctx.fill();else throw new Error("Unexpected shape:"+d)}this.updateLegends({style:this,resolution:i,z:s,viewScale:n})}};class ee extends M{constructor(t){super(t),t=t||{},this.ts=t.ts,this.noData=t.noData||(e=>e===void 0||e==""||e===null||isNaN(+e)),this.offsetX=t.offsetX||((e,i,s)=>0),this.width=t.width||((e,i,s)=>i),this.offsetY=t.offsetY||((e,i,s)=>0),this.height=t.height||((e,i,s)=>i),this.anchorModeY=t.anchorModeY||((e,i,s)=>"center"),this.lineWidth=t.lineWidth||((e,i,s,n)=>1.5*n),this.color=t.color||(()=>"black")}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0,a=l=>{let r,d;for(let c of this.ts){const f=l[c];f!=null&&((r==null||f<r)&&(r=f),(d==null||f>d)&&(d=f))}if(r!=null)return d-r};let o;for(let l of t){const r=a(l);r!=null&&(o==null||r>o)&&(o=r)}if(!o)return;const h=this.ts.length;e.ctx.lineCap="butt";for(let l of t){const r=this.lineWidth?this.lineWidth(l,i,s,n):void 0;if(!r||r<0)continue;const d=this.color?this.color(l,i,s,n):void 0;if(!d)continue;const c=this.offsetX?this.offsetX(l,i,s):0;if(c==null||isNaN(c))continue;const f=this.width?this.width(l,i,s):i;if(f==null||isNaN(f))continue;const u=this.offsetY?this.offsetY(l,i,s):0;if(u==null||isNaN(u))continue;const g=this.height?this.height(l,i,s):i;if(g==null||isNaN(g))continue;const p=this.anchorModeY?this.anchorModeY(l,i,s):"center";if(!p)continue;e.ctx.lineWidth=r,e.ctx.strokeStyle=d;let y,v;if(p==="first")y=l[this.ts[0]],v=0;else if(p==="last")y=l[this.ts[this.ts.length-1]],v=0;else if(p==="bottom"){for(let S of this.ts){const C=+l[S];C!=null&&(y==null||C<y)&&(y=C)}v=0}else if(p==="top"){for(let S of this.ts){const C=+l[S];C!=null&&(y==null||C>y)&&(y=C)}v=i}else if(p==="center"){let S,C;for(let k of this.ts){const z=l[k];z!=null&&((S==null||z<S)&&(S=z),(C==null||z>C)&&(C=z))}y=(+C+ +S)*.5,v=i/2}else{console.log("Unexpected anchorModeY: "+p);continue}const m=f/(h-1);let w=l[this.ts[0]];this.noData(w)||(e.ctx.beginPath(),e.ctx.moveTo(l.x+c,l.y+v+(w-y)*g/o+u));let b;for(let S=1;S<h;S++)b=l[this.ts[S]],this.noData(w)&&this.noData(b)||(!this.noData(w)&&this.noData(b)?e.ctx.stroke():this.noData(w)&&!this.noData(b)?(e.ctx.beginPath(),e.ctx.moveTo(l.x+S*m+c,l.y+v+(b-y)*g/o+u)):(e.ctx.lineTo(l.x+S*m+c,l.y+v+(b-y)*g/o+u),S==h-1&&e.ctx.stroke())),w=b}this.updateLegends({style:this,resolution:i,z:s,viewScale:n})}}class ie extends M{constructor(t){super(t),t=t||{},this.color=t.color,this.height=t.height||((e,i,s,n)=>i*.4),this.angle=t.angle!=null?t.angle:50,this.cornerLineStrokeColor=t.cornerLineStrokeColor||((e,i,s,n)=>"#999"),this.cornerLineWidth=t.cornerLineWidth||((e,i,s,n)=>n%90==0?0:.8*s),this.sVert=t.sVert!=null?t.sVert:!0,this.sHor=t.sHor!=null?t.sHor:!0}draw(t,e,i){this.filter&&(t=t.filter(this.filter));const s=e.view.z,n=this.viewScale?this.viewScale(t,i,s):void 0,a=Object.keys(this.color),o=i/2,h=this.offset(void 0,i,s),l=h.dx,r=h.dy,d=L.buildSides(t,i,this.angle%180!=90&&this.sVert,this.angle%180!=0&&this.sHor);if(d.length==0)return;const c=this.angle*Math.PI/180,f=Math.cos(c),u=Math.sin(c),g=Math.abs(this.angle)<90?e.extGeo.xMin:e.extGeo.xMax,p=this.angle<0?e.extGeo.yMax:e.extGeo.yMin;d.sort((v,m)=>Math.hypot(m.x-g,m.y-p)-Math.hypot(v.x-g,v.y-p));const y=v=>{if(!v)return;const m=this.cornerLineWidth?this.cornerLineWidth(v,i,s,this.angle):.8*s;if(m==0)return;e.ctx.strokeStyle=this.cornerLineStrokeColor?this.cornerLineStrokeColor(v,i,s,this.angle):"#333",e.ctx.lineWidth=m;const w=this.height(v,i,s,n);e.ctx.beginPath(),e.ctx.moveTo(v.x+o+l,v.y+o+r),e.ctx.lineTo(v.x+o+w*f+l,v.y+o+w*u+r),e.ctx.stroke()};e.ctx.lineCap="round";for(let v of d){const m=v.c1,w=v.c2,b=v.x,S=v.y,C=m?this.height(m,i,s,n):0,k=w?this.height(w,i,s,n):0,z=ht(m,a),U=ht(w,a);if(z==0&&U==0)continue;let _=0,V=0;for(let[K,vt]of Object.entries(this.color)){let $=m?+m[K]:0,Y=w?+w[K]:0;if($==0&&Y==0)continue;const R=C*_/z||0,B=C*(_+$)/z||0,W=k*V/U||0,D=k*(V+Y)/U||0;e.ctx.beginPath(),v.or=="h"?(e.ctx.moveTo(b+R*f+l,S-o+R*u+r),e.ctx.lineTo(b+W*f+l,S+o+W*u+r),e.ctx.lineTo(b+D*f+l,S+o+D*u+r),e.ctx.lineTo(b+B*f+l,S-o+B*u+r)):(e.ctx.moveTo(b-o+R*f+l,S+R*u+r),e.ctx.lineTo(b+o+W*f+l,S+W*u+r),e.ctx.lineTo(b+o+D*f+l,S+D*u+r),e.ctx.lineTo(b-o+B*f+l,S+B*u+r)),e.ctx.fillStyle=vt,e.ctx.fill(),_+=$,V+=Y,y(m),y(w)}}this.updateLegends({style:this,resolution:i,z:s,viewScale:n})}}const ht=(x,t)=>{if(!x)return 0;let e=0;for(let i of t){const s=x[i];s&&(e+=+s)}return e||0};class se extends M{constructor(t){super(t),t=t||{},this.image=t.image||(()=>""),this.size=t.size||((e,i)=>i),this.cache={}}async draw(t,e,i){const s=e.view.z,n=i/s,a=this.viewScale?this.viewScale(t,i,s):void 0;e.initCanvasTransform();for(let o of t){const h=this.image(o,i,s,a);if(!h)continue;let l=this.size(o,i,s,a)/s;if(!l)continue;const r=this.cache[h];if(r=="loading")return;if(r){const d=(n-l)/2;try{e.ctx.drawImage(r,e.geoToPixX(o.x)+d,e.geoToPixY(o.y)+d-n,l,l)}catch(c){console.error(c)}}else{this.cache[h]="loading";const d=new Image;d.onload=()=>{this.cache[h]=d,e.redraw()},d.onerror=()=>{console.warn("Could not retrieve image from",h)},d.src=h}}this.updateLegends({style:this,resolution:i,z:s,viewScale:a})}}let oe=class H extends P{constructor(t,e,i={}){super(i),i=i||{},this.dataset=t,this.styles=e,this.minPixelsPerCell=i.minPixelsPerCell||3,this.cellInfoHTML=i.cellInfoHTML||H.defaultCellInfoHTML}draw(t,e){const i=t.view.z,s=this.getDataset(i);if(s){s.getData(t.extGeo),s.updateViewCache(t.extGeo);for(const n of this.styles)n.visible&&!n.visible(i)||(t.ctx.globalAlpha=n.alpha?n.alpha(i):1,n.blendOperation&&(t.ctx.globalCompositeOperation=n.blendOperation(i)),t.setCanvasTransform(),n.draw(s.getViewCache(),t,s.getResolution()),n.filterColor&&n.drawFilter(t));if(e){for(const n of this.styles)if(!(n.visible&&!n.visible(i))&&(H.addLegends(e,n.legends),n.styles))for(const a of n.styles)a.visible&&!a.visible(i)||H.addLegends(e,a.legends)}}}static addLegends(t,e){if(Array.isArray(e))for(const i of e)this.addLegends(t,i);else t.node().append(e.div.node())}getDataset(t){return this.dataset.getDataset(t,this.minPixelsPerCell)}styles_(t){return arguments.length===0?this.styles:(arguments.length===1?Array.isArray(t)?this.styles=t:this.styles=[t]:this.styles=arguments,this)}static defaultCellInfoHTML(t){const e=[];for(const i of Object.keys(t))i!=="x"&&i!=="y"&&e.push("<b>",i,"</b>"," : ",t[i],"<br>");return e.join("")}};class ne extends P{constructor(t){if(super(t),t=t||{},this.cache={},this.url=t.url,this.urlFun=t.urlFun||((e,i,s)=>this.url+s+"/"+e+"/"+i+".png"),this.resolutions=t.resolutions,!this.resolutions||this.resolutions.length==0)throw new Error("No resolutions provided for background layer");this.nbPix=t.nbPix||256,this.origin=t.origin||[0,0],this.z0=t.z0||0}get(t,e,i){let s=this.cache[t];if(s&&(s=s[e],!!s))return s[i]}put(t,e,i,s){this.cache[e]||(this.cache[e]={}),this.cache[e][i]||(this.cache[e][i]={}),this.cache[e][i][s]=t}draw(t){if(!this.resolutions||this.resolutions.length==0){console.error("No resolutions provided for background layer");return}const e=t.view.z,i=this.origin[0],s=this.origin[1];let n=0;for(n=0;n<this.resolutions.length&&!(this.resolutions[n]<e);n++);n-=1,n=Math.max(0,n),n=Math.min(n,this.resolutions.length-1);const a=this.resolutions[n];n+=this.z0;const o=this.nbPix*a,h=o/e,l=g=>Math.ceil((g-i)/o),r=g=>Math.ceil(-(g-s)/o),d=l(t.extGeo.xMin)-1,c=l(t.extGeo.xMax),f=r(t.extGeo.yMin),u=r(t.extGeo.yMax)-1;for(let g=d;g<c;g++)for(let p=u;p<f;p++){let y=this.get(n,g,p);if(!y){const w=new Image;this.put(w,n,g,p),w.onload=()=>{t.redraw()},w.onerror=()=>{this.put("failed",n,g,p)},w.src=this.urlFun(g,p,n);continue}if(y==="failed")continue;if(!(y instanceof HTMLImageElement)){console.log(y);continue}if(y.width==0||y.height==0)continue;const v=i+g*o,m=s-p*o;try{t.initCanvasTransform(),t.ctx.drawImage(y,t.geoToPixX(v),t.geoToPixY(m),h,h)}catch(w){console.error(w)}}}}let re=class extends P{constructor(t){super(t),t=t||{},this.url=t.url,this.img=void 0,this.xMin=void 0,this.xMax=void 0,this.yMin=void 0,this.yMax=void 0}hasMoved(t){return t.xMin!=this.xMin||t.xMax!=this.xMax||t.yMin!=this.yMin?!0:t.yMax!=this.yMax}draw(t){if(t.updateExtentGeo(0),!this.hasMoved(t.extGeo)&&this.img)t.initCanvasTransform(),t.ctx.drawImage(this.img,0,0,t.w,t.h);else{this.xMin=t.extGeo.xMin,this.xMax=t.extGeo.xMax,this.yMin=t.extGeo.yMin,this.yMax=t.extGeo.yMax;const e=[];e.push(this.url),e.push("&width="),e.push(t.w),e.push("&height="),e.push(t.h),e.push("&bbox="),e.push(t.extGeo.xMin),e.push(","),e.push(t.extGeo.yMin),e.push(","),e.push(t.extGeo.xMax),e.push(","),e.push(t.extGeo.yMax);const i=e.join("");this.img||(this.img=new Image,this.img.onload=()=>{t.redraw()},this.img.onerror=()=>{console.warn("Could not retrieve WMS background image from",i)}),this.img.src=i}}};class ae extends P{constructor(t){super(t),t=t||{},this.url=t.url,this.xMin=t.xMin||0,this.yMax=t.yMax||0,this.width=t.width||2e4,this.height=t.height||2e4,this.img=void 0}draw(t){if(this.img){const e=t.geoToPixX(this.xMin),i=t.geoToPixY(this.yMax),s=t.getView().z;t.initCanvasTransform(),t.ctx.drawImage(this.img,e,i,this.width/s,this.height/s)}else this.img||(this.img=new Image,this.img.onload=()=>{t.redraw()},this.img.onerror=()=>{console.warn("Could not retrieve background image from",this.url)}),this.img.src=this.url}}let le=class extends P{constructor(t){super(t),t=t||{},this.url=t.url,this.style=t.style||(()=>"bold 1em Arial"),this.color=t.color||(t.dark?()=>"#ddd":()=>"#222"),this.haloColor=t.haloColor||(t.dark?()=>"#000000BB":()=>"#FFFFFFBB"),this.haloWidth=t.haloWidth||(()=>4),this.textAlign=t.textAlign||"start",this.offsetPix=t.offsetPix||[5,5],this.preprocess=t.preprocess,this.labels=void 0,this.loadingStatus="notLoaded"}draw(t){if(!this.labels){this.load(t.redraw);return}const e=t.view.z;t.ctx.textAlign=this.textAlign||"start",t.ctx.lineJoin="bevel",t.ctx.lineCap="butt",t.initCanvasTransform();for(const i of this.labels){const s=this.style(i,e);if(!s||(t.ctx.font=s,!t.toDraw(i)))continue;const n=t.geoToPixX(i.x)+this.offsetPix[0],a=t.geoToPixY(i.y)-this.offsetPix[1];if(this.haloColor&&this.haloWidth){const o=this.haloColor(i,e),h=this.haloWidth(i,e);o&&h&&h>0&&(t.ctx.strokeStyle=o,t.ctx.lineWidth=h,t.ctx.strokeText(i.name,n,a))}if(this.color){const o=this.color(i,e);o&&(t.ctx.fillStyle=o,t.ctx.fillText(i.name,n,a))}}}async load(t){if(!this.url){console.log("Failed loading labels: No URL specified. "+this.url),this.loadingStatus="failed",this.labels=[];return}if(this.loadingStatus=="notLoaded"){this.loadingStatus="loading";try{const e=await et(this.url);if(this.preprocess){this.labels=[];for(const i of e)this.preprocess(i)!=!1&&this.labels.push(i)}else this.labels=e;this.loadingStatus="loaded",t&&t()}catch{console.log("Failed loading labels from "+this.url),this.labels=[],this.loadingStatus="failed"}}}},he=class extends P{constructor(t){super(t),t=t||{},this.url=t.url,this.preprocess=t.preprocess,this.shape=t.shape||((e,i)=>"circle"),this.size=t.size||((e,i)=>10),this.strokeStyle=t.strokeStyle||((e,i)=>"red"),this.fillStyle=t.fillStyle||((e,i)=>"black"),this.lineWidth=t.lineWidth||((e,i)=>2),this.color=t.color||((e,i)=>"gray"),this.width=t.width||((e,i)=>2),this.lineDash=t.lineDash||((e,i)=>{}),this.fs=void 0,this.loadingStatus="notLoaded"}draw(t){if(!this.fs){this.load(t.redraw);return}const e=t.view.z;for(const i of this.fs){const s=i.geometry.type;if(s=="Point"){const n=i.geometry.coordinates,a=this.shape(i,e);if(!a||a=="none")continue;const o=this.size(i,e)*e;if(!o)continue;const h=this.strokeStyle(i,e),l=this.fillStyle(i,e),r=this.lineWidth(i,e)*e;h&&(t.ctx.strokeStyle=h),l&&(t.ctx.fillStyle=l),r&&(t.ctx.lineWidth=r),a=="circle"?(t.ctx.beginPath(),t.ctx.arc(n[0],n[1],o/2,0,2*Math.PI,!1),l&&t.ctx.fill(),h&&r&&t.ctx.stroke()):a=="square"?(t.ctx.beginPath(),t.ctx.rect(n[0]-o/2,n[1]-o/2,o,o),l&&t.ctx.fill(),h&&r&&t.ctx.stroke()):console.error("Unexpected shape for point geojson: "+a)}else if(s=="LineString"){const n=i.geometry.coordinates;if(n.length<2)continue;const a=this.color(i,e);if(!a||a=="none")continue;t.ctx.strokeStyle=a;const o=this.width(i,e);if(!o||o<0)continue;t.ctx.lineWidth=o*e;const h=this.lineDash(i,e);h&&t.ctx.setLineDash(h),t.ctx.beginPath(),t.ctx.moveTo(n[0][0],n[0][1]);for(let l=1;l<n.length;l++)t.ctx.lineTo(n[l][0],n[l][1]);t.ctx.stroke()}else console.log("Unsupported geometry type in GeoJSONLayer: "+s)}t.ctx.setLineDash([])}async load(t){if(!this.url){console.log("Failed loading boundaries: No URL specified. "+this.url),this.loadingStatus="failed",this.labels=[];return}if(this.loadingStatus=="notLoaded"){this.loadingStatus="loading";try{const e=(await tt(this.url)).features;if(this.preprocess){this.fs=[];for(const i of e)this.preprocess(i)!=!1&&this.fs.push(i)}else this.fs=e;this.loadingStatus="loaded",t&&t()}catch{console.log("Failed loading boundaries from "+this.url),this.fs=[],this.loadingStatus="failed"}}}},E=class{constructor(t){t=t||{},this.id=t.id,this.top=t.top,this.bottom=t.bottom,this.left=t.left,this.right=t.right,this.background=t.background||"none",this.padding=t.padding||"5px",this.border=t.border||"0px",this["border-radius"]=t["border-radius"]||"none",this["box-shadow"]=t["box-shadow"]||"none",this["font-family"]=t["font-family"]||"Helvetica, Arial, sans-serif",this.id&&(this.div=T("#"+this.id)),(!this.div||this.div.empty())&&(this.div=T(document.createElement("div")),this.id&&this.div.attr("id",this.id)),this.div.style("background",this.background),this.div.style("padding",this.padding),this.div.style("border",this.border),this.div.style("border-radius",this["border-radius"]),this.div.style("box-shadow",this["box-shadow"]),this.div.style("font-family",this["font-family"]),this.title=t.title,this.titleFontSize=t.titleFontSize||"0.8em",this.titleFontWeight=t.titleFontWeight||"bold",this.labelFontSize=t.labelFontSize||"0.8em",this.labelUnitText=t.labelUnitText||"",this.labelFormat=t.labelFormat}makeTitle(){this.title&&this.div.append("div").style("font-size",this.titleFontSize).style("font-weight",this.titleFontWeight).style("margin-bottom","7px").text(this.title)}style(t,e){return arguments.length==1?this.div.style(t):(this.div.style(t,e),this)}update(t={}){console.error("Legend update not implemented yet.")}},ce=class extends E{constructor(t){super(t),t=t||{},this.colorScale=t.colorScale,this.textScale=t.textScale||(e=>e),this.margin=t.margin||5,this.tickSize=t.tickSize||6,this.ticks=t.ticks||Math.floor(this.width/50),this.tickFormat=t.tickFormat,this.tickUnit=t.tickUnit,this.fontSize=t.fontSize||"0.8em",this.invert=t.invert,this.width=t.width||300,this.height=t.height||15}update(t){this.div.selectAll("*").remove(),this.makeTitle();const e=this.width+2*this.margin,i=this.height+this.margin+this.tickSize+10,s=this.div.append("svg").attr("width",e).attr("height",i).append("g").attr("transform","translate("+this.margin+" 0)"),n=this.width,a=this.height,o=5;for(let l=0;l<n;l+=o){let r=l/(n-1);this.invert&&(r=1-r),s.append("rect").attr("x",l).attr("y",0).attr("width",o).attr("height",a).style("fill",this.colorScale(r,t.viewScale))}for(let l=0;l<this.ticks;l++){let r=l/(this.ticks-1);s.append("line").attr("x1",n*r).attr("y1",0).attr("x2",n*r).attr("y2",a+this.tickSize).style("stroke","black"),s.append("text").attr("id","ticklabel_"+l).attr("x",n*r).attr("y",a+this.tickSize+2).style("font-size",this.fontSize).style("text-anchor",l==0?"start":l==this.ticks-1?"end":"middle").style("alignment-baseline","top").style("dominant-baseline","hanging").style("pointer-events","none")}const h=this.tickFormat&&this.tickFormat!="text"?this.tickFormat:l=>l;for(let l=0;l<this.ticks;l++){let r=l/(this.ticks-1);const d=this.textScale(r,t.viewScale),c=(d?h(d):"0")+(this.tickUnit?this.tickUnit:"");c!=null&&this.div.select("#ticklabel_"+l).text(c)}}},de=class extends E{constructor(t){super(t),t=t||{},this.colors=t.colors,this.breaks=t.breaks,this.width=t.width||300,this.height=t.height||15,this.tickSize=t.tickSize||3,this.invert=t.invert}update(t){this.div.selectAll("*").remove(),this.makeTitle();const e=this.colors(t.viewScale),i=this.breaks(t.viewScale);if(!i)return;const s=e.length;if(s==0)return;const n=this.width/s,a=this.div.append("svg").attr("width",this.width).attr("height",this.height+this.tickSize+2+10);for(let o=0;o<s;o++)a.append("rect").attr("x",o*n).attr("y",0).attr("width",n).attr("height",this.height).style("fill",e[o]);for(let o=1;o<s;o++)a.append("line").attr("x1",n*o).attr("y1",0).attr("x2",n*o).attr("y2",this.height+this.tickSize).style("stroke","black");for(let o=1;o<s;o++){let h=i[o-1];isNaN(h)||h==null||(this.labelFormat&&(h=this.labelFormat(h)),a.append("text").attr("id","ticklabel_"+o).attr("x",n*o).attr("y",this.height+this.tickSize+2).style("font-size",this.labelFontSize).style("text-anchor","middle").style("alignment-baseline","top").style("dominant-baseline","hanging").style("pointer-events","none").text(h))}}},fe=class extends E{constructor(t){super(t),t=t||{},this.colorLabel=t.colorLabel||[["gray","-"]],this.shape=t.shape||"circle",this.dimension=t.dimension||{r:8},this.strokeColor=t.strokeColor||"gray",this.strokeWidth=t.strokeWidth||1}update(){this.div.selectAll("*").remove(),this.makeTitle();const t=this.colorLabel.length;if(t!=0)for(let e=0;e<t;e++){const i=this.colorLabel[e],s=this.div.append("div"),n=this.strokeWidth;if(this.shape==="square"){const a=this.dimension.h||15,o=this.dimension.w||20;s.append("div").style("display","inline").append("svg").attr("width",o+2*n).attr("height",a+2*n).append("rect").attr("x",n).attr("y",n).attr("width",o).attr("height",a).style("fill",i[0]).style("stroke",this.strokeColor).style("stroke-width",this.strokeWidth)}else if(this.shape==="circle"){const a=this.dimension.r||8,o=2*a+2*n;s.append("div").style("display","inline").append("svg").attr("width",o).attr("height",o).append("circle").attr("cx",a+n).attr("cy",a+n).attr("r",a).style("fill",i[0]).style("stroke",this.strokeColor).style("stroke-width",this.strokeWidth)}else throw new Error("Unexpected shape:"+this.shape);s.append("div").style("display","inline").style("padding-left","5px").style("font-size",this.labelFontSize).text(i[1])}}};function ct(x,t=[8,6,5,4,2.5,2]){const e=Math.pow(10,Math.floor(Math.log10(x)));for(let i of t)if(e*i<=x)return e*i;return e}let I=class extends E{constructor(t){super(t),t=t||{},this.label=t.label||void 0,this.size=t.size||void 0,this.shape=t.shape||"circle",this.fillColor=t.fillColor||"none",this.strokeColor=t.strokeColor||"gray",this.strokeWidth=t.strokeWidth||1,this.color=t.color||"gray",this.length=t.length||((e,i,s)=>e)}update(t){this.div.selectAll("*").remove(),this.makeTitle();let e=this.label(t.viewScale,t.cells,t.resolution,t.z),i;if(this.size?i=this.size(t.viewScale,t.resolution,t.z)/t.z:i=t.viewScale(+e)/t.z,!i)return;this.labelFormat&&!isNaN(+e)&&(e=this.labelFormat(e));const s=this.div.append("div"),n=()=>s.append("svg").attr("width",i+this.strokeWidth+2).attr("height",i+this.strokeWidth+2).style("","inline-block");if(this.shape==="square")n().append("rect").attr("x",0).attr("y",0).attr("width",i).attr("height",i).style("fill",this.fillColor).style("stroke",this.strokeColor).style("stroke-width",this.strokeWidth);else if(this.shape==="circle"){const a=(i+this.strokeWidth)*.5;n().append("circle").attr("cx",a+1).attr("cy",a+1).attr("r",a).style("fill",this.fillColor).style("stroke",this.strokeColor).style("stroke-width",this.strokeWidth)}else if(this.shape!=="donut"&&this.shape!=="diamond")if(this.shape==="line"){let a=this.length?this.length(t.resolution,t.z,t.viewScale):t.resolution;a/=t.z,s.append("svg").attr("width",a).attr("height",i).style("","inline-block").append("line").attr("x1",0).attr("y1",i/2).attr("x2",a).attr("y2",i/2).style("stroke",this.color).style("stroke-width",i)}else throw new Error("Unexpected shape:"+this.shape);s.append("div").style("display","inline").style("padding-left","5px").style("font-size",this.labelFontSize).text(e+(this.labelUnitText?" ":"")+this.labelUnitText)}};function xe(x,t,e={}){const i=[];for(let s of x)e.title=s==x[0]?e.title:void 0,e.size=()=>t(s),e.label=()=>s,i.push(new I(e));return i}function ue(x,t={}){const e=t.k||[.9,.5,.2,.05],i=[];for(let s of e)t.title=s==e[0]?t.title:void 0,t.label=(n,a)=>ct(s*it(a,x)),i.push(new I(t));return i}function ge(x,t,e={}){const i=e.labelFormat||(a=>a),s=e.labelText||dt(i),n=[];for(let a=t.length-1;a>=0;a--)e.title=a==t.length-1?e.title:void 0,e.size=()=>t[a],e.label=()=>s(x[a-1],x[a]),n.push(new I(e));return n}function ve(x,t={}){const e=t.labelFormat||(a=>a),i=t.labelText||dt(e),s=[],n=t.viewScaleFun||(a=>a);for(let a=x-1;a>=0;a--)t.title=a==x-1?t.title:void 0,t.size=o=>n(o).values[a],t.label=o=>i(n(o).breaks[a-1],n(o).breaks[a]),s.push(new I(t));return s}function dt(x){return(t,e)=>t==null&&e==null?"":e==null?"> "+x(t):t==null?"< "+x(e):x(t)+" - "+x(e)}class ft extends E{constructor(t){super(t),t=t||{},this.orientation=t.orientation||0,this.color=t.color||((e,i,s)=>"gray"),this.width=t.width||((e,i,s)=>3*i),this.length=t.length||((e,i,s)=>e),this.label=t.label||"-"}update(t){this.div.selectAll("*").remove(),this.makeTitle();const e=this.div.append("div"),i=this.color(t.resolution,t.z,t.viewScale),s=this.width(t.resolution,t.z,t.viewScale)/t.z,n=this.length(t.resolution,t.z,t.viewScale)/t.z,a=Math.max(n,s),o=e.append("svg").attr("width",a).attr("height",a).style("","inline-block"),h=Math.cos(-this.orientation*Math.PI/180),l=Math.sin(-this.orientation*Math.PI/180),r=a*.5,d=n*.5;o.append("line").attr("x1",r-h*d).attr("y1",r-l*d).attr("x2",r+h*d).attr("y2",r+l*d).style("stroke",i).style("stroke-width",s),e.append("div").style("display","inline").style("padding-left","5px").style("font-size",this.labelFontSize).text(this.label+(this.labelUnitText?" ":"")+this.labelUnitText)}}function pe(x,t,e={}){const i=[];for(let s=0;s<x.length;s++)e.title=s==0?e.title:void 0,e.orientation=x[s],e.label=t[s],i.push(new ft(e));return i}class ye extends E{constructor(t){super(t),t=t||{},this.classifier=t.classifier,this.width=t.width||150,this.selectionColor=this.selectionColor||"red",this.tooltip=t.tooltip,this.texts=t.texts,this.leftText=t.leftText||"Category 0",this.topText=t.topText||"Category 1",this.rightText=t.rightText||"Category 2",this.centerCoefficient=t.centerCoefficient||this.classifier.centerCoefficient}update(t){this.div.selectAll("*").remove(),this.makeTitle();const e=.866025,i=this.width,s=i*e,n=this.classifier,a=this.selectionColor,o=0,h=this.tooltip,l=this.texts||{},r=2,d=12,c=this.div.append("svg").attr("width",i+o).attr("height",s+4*r+2*d);c.append("text").attr("x",i/2).attr("y",r+d).text(this.topText).attr("font-size",d).attr("text-anchor","middle"),c.append("text").attr("x",0).attr("y",3*r+2*d+s).text(this.leftText).attr("font-size",d).attr("text-anchor","start"),c.append("text").attr("x",i).attr("y",3*r+2*d+s).text(this.rightText).attr("font-size",d).attr("text-anchor","end");const f=c.append("g").attr("transform","translate("+o/2+" "+(o/2+(2*r+d))+")"),u=(b,S,C)=>{b.attr("fill",S).on("mouseover",function(k){T(this).attr("fill",a),!(!h||!C)&&(h.html(C),h.setPosition(k),h.show())}).on("mouseout",function(){T(this).attr("fill",S),h&&h.hide()}),h&&C&&b.on("mousemove",function(k){h.setPosition(k)})},g=f.append("polygon").attr("points","0,"+s+" "+i/3+","+s+" "+i/2+","+s*2/3+" "+i/6+","+s*2/3);u(g,n.colors[0],l[0]);const p=f.append("polygon").attr("points",i/2+",0 "+i*2/3+","+s/3+" "+i/2+","+s*2/3+" "+i/3+","+s/3);u(p,n.colors[1],l[1]);const y=f.append("polygon").attr("points",i+","+s+" "+i*5/6+","+2*s/3+" "+i/2+","+s*2/3+" "+i*2/3+","+s);u(y,n.colors[2],l[2]);const v=f.append("polygon").attr("points",i/2+","+s*2/3+" "+i*5/6+","+s*2/3+" "+i*2/3+","+s/3);u(v,n.mixColors[0],l.m12);const m=f.append("polygon").attr("points",i/2+","+s*2/3+" "+i/3+","+s+" "+i*2/3+","+s);u(m,n.mixColors[1],l.m02);const w=f.append("polygon").attr("points",i/2+","+s*2/3+" "+i/6+","+s*2/3+" "+i/3+","+s/3);if(u(w,n.mixColors[2],l.m01),this.centerCoefficient){const b=f.append("circle").attr("cx",i/2).attr("cy",s*2/3).attr("r",this.centerCoefficient*s/3);u(b,n.centerColor,l.center)}}}const F=x=>x;F.invert=F;const me=(x=3)=>{if(x==0)return F;const t=Math.exp(x)-1,e=i=>(Math.exp(i*x)-1)/t;return e.invert=i=>Math.log(t*i+1)/x,e},we=(x=3)=>{if(x==0)return F;const t=Math.exp(x),e=1-t,i=s=>1-Math.log(t+s*e)/x;return i.invert=s=>(Math.exp((1-s)*x)-t)/e,i},be=(x=3)=>{if(x==1)return F;const t=i=>Math.pow(i,x),e=1/x;return t.invert=i=>Math.pow(i,e),t},Se=(x=3)=>{if(x==1)return F;const t=1/x,e=i=>1-Math.pow(1-i,t);return e.invert=i=>1-Math.pow(1-i,x),e},xt=(x=.8)=>{if(x==0)return F;if(x==1)return t=>Math.sqrt(t*(2-t));{const t=x/(1-x);return e=>Math.sqrt(1/(t*t)+e*(2/t+2-e))-1/t}},Ce=(x=.8)=>{if(x==0)return F;const t=xt(x);return e=>1-t(1-e)},ut=(x,t,e={})=>{const i=x[0],s=x[1],n=x[2],[a,o,h]=e.center||[1/3,1/3,1/3],l=e.withMixedClasses!=null?e.withMixedClasses:!0,r=e.centerCoefficient?1-e.centerCoefficient:void 0,d=c=>{const f=t(c);if(!f)return;const[u,g,p]=[+c[i]/f,+c[s]/f,+c[n]/f];return u>=a&&g<=o&&p<=h?r!=null&&(p-h)*(o-r*o)>=(g-r*o)*(r*h-h)?"center":"0":u<=a&&g>=o&&p<=h?r!=null&&(p-h)*(a-r*a)>=(u-r*a)*(r*h-h)?"center":"1":u<=a&&g<=o&&p>=h?r!=null&&(g-o)*(a-r*a)>=(u-r*a)*(r*o-o)?"center":"2":u<=a&&g>=o&&p>=h?r!=null&&u>r*a?"center":l?"m12":g>p?"1":"2":u>=a&&g<=o&&p>=h?r!=null&&g>r*o?"center":l?"m02":u>p?"0":"2":u>=a&&g>=o&&p<=h?r!=null&&p>r*h?"center":l?"m01":g>u?"1":"0":"unknown"};return d.center=[a,o,h],d.centerCoefficient=e.centerCoefficient,d},Me=(x,t,e,i={})=>{const[s,n,a]=e||["red","green","blue"],o=i.colorInterpolation||St,h=i.withMixedClasses!=null?i.withMixedClasses:!0,l=(p,y)=>o(p,y)(.5),[r,d,c]=i.mixedColors||h?[l(n,a),l(s,a),l(s,n)]:[],f=i.centerColor||o(l(s,n),a)(.333),u=ut(x,t,i),g=p=>{const y=u(p);return y=="0"?s:y=="1"?n:y=="2"?a:y=="m12"?r:y=="m02"?d:y=="m01"?c:y=="center"?f:i.defaultColor||"black"};return g.center=u.center,g.centerCoefficient=i.centerCoefficient,g.colors=[s,n,a],g.mixColors=[r,d,c],g.centerColor=f,g.classifier=u,g},Te=Z.getParameterByName;Ct({decimal:".",thousands:" ",grouping:[3],currency:["","\u20AC"]});export{ne as BackgroundLayer,ae as BackgroundLayerImage,re as BackgroundLayerWMS,At as CSVGrid,fe as ColorCategoryLegend,de as ColorDiscreteLegend,ce as ColorLegend,Bt as CompositionStyle,O as Dataset,Ut as DotDensityStyle,Z as GeoCanvas,he as GeoJSONLayer,oe as GridLayer,se as ImageStyle,ie as IsoFenceStyle,Et as JSGrid,Rt as JoyPlotStyle,le as LabelLayer,P as Layer,jt as LegoStyle,kt as Map,Kt as MosaicStyle,Ft as MultiResolutionDataset,te as NinjaStarStyle,ft as OrientationLegend,Gt as PillarStyle,Wt as SegmentStyle,It as ShapeColorSizeStyle,Ot as SideCategoryStyle,L as SideStyle,I as SizeLegend,J as SquareColorCategoryWebGLStyle,Qt as SquareColorWebGLStyle,q as StrokeStyle,M as Style,at as TanakaStyle,ye as TernaryLegend,Dt as TextStyle,Pt as TiledGrid,ee as TimeSeriesStyle,Ce as circularInverseScale,xt as circularScale,Q as classifier,Xt as colorClassifier,rt as discreteColors,me as exponentialScale,Te as getParameterByName,we as logarithmicScale,ct as nice,pe as orientationLegend,Se as powerInverseScale,be as powerScale,ge as sizeDiscreteLegend,ve as sizeDiscreteViewScaleLegend,xe as sizeLegend,ue as sizeLegendViewScale,ut as ternaryClassifier,Me as ternaryColorClassifier,Vt as viewScale,Yt as viewScaleColor,Zt as viewScaleColorQuantile,qt as viewScaleCombination,$t as viewScaleQuantile};
